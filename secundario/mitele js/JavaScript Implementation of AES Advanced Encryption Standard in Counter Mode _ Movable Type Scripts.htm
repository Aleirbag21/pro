<!DOCTYPE html>
<html lang="en"><head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<title>JavaScript Implementation of AES Advanced Encryption Standard in Counter Mode | Movable Type Scripts</title>
<meta charset="utf-8">
<meta name="author" content="Chris Veness, www.movable-type.co.uk">
<meta name="keywords" content="AES advanced encryption algorithm standard counter mode operation javascript">
<link rel="stylesheet" href="JavaScript%20Implementation%20of%20AES%20Advanced%20Encryption%20Standard%20in%20Counter%20Mode%20_%20Movable%20Type%20Scripts_files/mtl5.css">
<link rel="stylesheet" href="JavaScript%20Implementation%20of%20AES%20Advanced%20Encryption%20Standard%20in%20Counter%20Mode%20_%20Movable%20Type%20Scripts_files/prettify.css">
<style>
  label  { display: inline-block; width: 8em; }
  button { font-size: 0.9em; }
</style>
<!--[if lte IE 7]>
<style> /* IE! sigh! */
  ul    { position: relative; top: 0.5em; }
  ul li { vertical-align: top; position: relative; top: -0.5em; }
  ul li { max-width: none; }
</style>
<![endif]-->
<script src="JavaScript%20Implementation%20of%20AES%20Advanced%20Encryption%20Standard%20in%20Counter%20Mode%20_%20Movable%20Type%20Scripts_files/aes.js">/* AES JavaScript implementation */</script>
<script src="JavaScript%20Implementation%20of%20AES%20Advanced%20Encryption%20Standard%20in%20Counter%20Mode%20_%20Movable%20Type%20Scripts_files/aes-ctr.js">/* AES Counter Mode implementation */</script>
<script src="JavaScript%20Implementation%20of%20AES%20Advanced%20Encryption%20Standard%20in%20Counter%20Mode%20_%20Movable%20Type%20Scripts_files/base64.js">/* Base64 encoding */</script>
<script src="JavaScript%20Implementation%20of%20AES%20Advanced%20Encryption%20Standard%20in%20Counter%20Mode%20_%20Movable%20Type%20Scripts_files/utf8.js">/* UTF-8 encoding */</script>
<script src="JavaScript%20Implementation%20of%20AES%20Advanced%20Encryption%20Standard%20in%20Counter%20Mode%20_%20Movable%20Type%20Scripts_files/jquery.js"></script>
<script src="JavaScript%20Implementation%20of%20AES%20Advanced%20Encryption%20Standard%20in%20Counter%20Mode%20_%20Movable%20Type%20Scripts_files/mtl.js">/* MTL utils */</script>
<script src="JavaScript%20Implementation%20of%20AES%20Advanced%20Encryption%20Standard%20in%20Counter%20Mode%20_%20Movable%20Type%20Scripts_files/prettify.js">/* google-code-prettify */</script>
<script>
  $(document).ready(function() {
    prettyPrint();
  });
</script>
<script>
/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -  */

function byteArrayToHexStr(b) {  // convert byte array to hex string for displaying test vectors
  var s = '';
  for (var i=0; i<b.length; i++) s += b[i]<0x10 ? '0'+b[i].toString(16)+' ' : b[i].toString(16)+' ';
  return s;
}

String.prototype.toCodes = function() {
  if (this.length == 0) return '';
  var arr = this.split('');
  for (a in arr) arr[a] = arr[a].charCodeAt(0);
  return arr.join(':');
}

function verifyKeyExpansion() {
  var cipher = [0x2b, 0x7e, 0x15, 0x16, 0x28, 0xae, 0xd2, 0xa6, 
                0xab, 0xf7, 0x15, 0x88, 0x09, 0xcf, 0x4f, 0x3c];
  alert('128: '+keyScheduleToHexStr(Aes.keyExpansion(cipher)));
  var cipher = [0x8e, 0x73, 0xb0, 0xf7, 0xda, 0x0e, 0x64, 0x52, 
                0xc8, 0x10, 0xf3, 0x2b, 0x80, 0x90, 0x79, 0xe5, 
                0x62, 0xf8, 0xea, 0xd2, 0x52, 0x2c, 0x6b, 0x7b];
  alert('192: '+keyScheduleToHexStr(Aes.keyExpansion(cipher)));
  var cipher = [0x60, 0x3d, 0xeb, 0x10, 0x15, 0xca, 0x71, 0xbe, 
                0x2b, 0x73, 0xae, 0xf0, 0x85, 0x7d, 0x77, 0x81, 
                0x1f, 0x35, 0x2c, 0x07, 0x3b, 0x61, 0x08, 0xd7, 
                0x2d, 0x98, 0x10, 0xa3, 0x09, 0x14, 0xdf, 0xf4];
  alert('256: '+keyScheduleToHexStr(Aes.keyExpansion(cipher)));
}

function keyScheduleToHexStr(keySchedule) {  // return expanded key as hex words, as per FIPS-197§A
  var d = '';
  for (w=0; w<keySchedule.length; w++) {
    for (var b=0; b<4; b++) {
      var byte = keySchedule[w][b];
      d += byte<0x10 ? '0'+byte.toString(16) : byte.toString(16);
    }
    d += ' ';
  }
  return d;
}

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -  */
</script>
</head>

<body>
<header> <a href="http://www.movable-type.co.uk/"><img src="JavaScript%20Implementation%20of%20AES%20Advanced%20Encryption%20Standard%20in%20Counter%20Mode%20_%20Movable%20Type%20Scripts_files/mtl.gif" alt="Movable Type Home Page" height="120" width="120"></a>
  <h1>Movable Type Scripts</h1>
  <hr>
  <h2>AES Advanced Encryption Standard</h2>
</header>

  <p><b>AES</b> is a ‘symmetric block cipher’ for encrypting texts which can be decrypted with the original
    encryption key.</p>
  <p>For many purposes, a simpler encryption algorithm such as <a href="http://www.movable-type.co.uk/scripts/tea-block.html">TEA</a> is perfectly
    adequate – but if you suspect the world’s best cryptographic minds, and a few million dollars of
    computing resource, might be attempting to crack your security, then <a target="_blank" href="http://en.wikipedia.org/wiki/Advanced_Encryption_Standard">AES</a>,
    based on the <i>Rijndael</i> algorithm, is the tightest security currently available (approved by
    the US government for classified information up to ‘Secret’ – and in in 192 or 256 key lengths, up
    to ‘Top Secret’). AES was adopted by NIST in 2001 as 
    <a target="_blank" href="http://csrc.nist.gov/publications/PubsFIPS.html#197">FIPS-197</a>, and is the replacement for DES which was 
    <a target="_blank" href="http://csrc.nist.gov/publications/fips/05-9945-DES-Withdrawl.pdf">withdrawn</a> in 2005.</p>
  <p>I developed this JavaScript implementation to to illustrate the original AES standard (NIST 
    <a target="_blank" href="http://csrc.nist.gov/publications/PubsFIPS.html#197">FIPS-197</a>)
    as closely as possible. It is intended as an introduction for people seeking to learn something about
    implementing encryption, not an authoritative implementation – cryptography experts will already
    know more than I present here. The emphasis is on transparency and fidelity to the standard rather
    than efficiency.</p>
  <p>This script also includes a wrapper function which implements AES in the ‘Counter’ 
    <a target="_blank" href="http://en.wikipedia.org/wiki/Block_cipher_modes_of_operation#Counter_.28CTR.29">mode
    of operation</a> (specified in NIST SP <a target="_blank" href="http://csrc.nist.gov/publications/nistpubs/#sp800-38A">800-38A</a>)
    to encrypt arbitrary texts – many descriptions of AES limit themselves to the Cipher routine itself,
    and don’t consider how it can be used to encrypt texts.</p>
  <form name="f">
  <fieldset><legend>Functional demo</legend>
  <ul>
    <li>
      <label for="pw">Password</label>
      <input name="pw" id="pw" value="L0ck it up saf3" class="w12" type="text">
    </li>
    <li>
      <label for="pt">Plaintext</label>
      <textarea name="pt" id="pt" class="w36">pssst ... đon’t tell anyøne!</textarea>
    </li>
    <li><label><button type="button" name="encrypt" id="encrypt" onclick="f.cipher.value = Aes.Ctr.encrypt(f.pt.value, f.pw.value, 256)">Encrypt it</button>
      </label>
      <textarea name="cipher" id="cipher" class="w36"></textarea>
    </li>
    <li><label><button type="button" name="decrypt" id="decrypt" onclick="f.plain.value = Aes.Ctr.decrypt(f.cipher.value, f.pw.value, 256)">Decrypt it</button>
      </label>
      <textarea name="plain" id="plain" class="w36"></textarea>
    </li>
  </ul>
  </fieldset>
  </form>
  <p id="debug">&nbsp;</p>
  <p>Much of the Rijndael algorithm is based on arithmetic on a <i><a target="_blank" href="http://en.wikipedia.org/wiki/Finite_field">finite
        field</a></i>, or <i>Galois field</i> (after the mathematician). Regular arithmetic works on
        an infinite range of numbers – keep doubling a number and it will get ever bigger. Arithmetic
        in a finite field is limited to numbers within that field. The Rijndael algorithm works in GF(2<sup>8</sup>),
        in which arithmetic results can always be stored within one byte – which is pretty convenient
        for computers. I can’t begin to understand the <a target="_blank" href="http://en.wikipedia.org/wiki/Finite_field_arithmetic">maths</a> (considering
        that addition and subtraction are the same thing – an <span class="small-caps">xor</span> operation
        – and multiplication is performed ‘modulo an irreducible polynomial’: doubling 0x80 in GF(2<sup>8</sup>)
        gives 0x1b).</p>
  <p>The Rijndael algorithm lends itself to widely differing implementations, since the maths can be
    either coded directly, or pre-computed as lookup tables – directly parallel to using log tables for
    arithmetic. Different implementations can have varying pay-offs between speed, complexity, and storage
    requirements. Some may barely resemble each other. In this implementation, I have followed the standard
    closely; as per the standard, I have used a lookup table (‘<a target="_blank" href="http://en.wikipedia.org/wiki/S-box">S-box</a>’)
    to implement the multiplicative inverse (i.e. 1/x) within a finite field (used for the SubBytes transformation),
    but other calculations are made directly rather than being pre-computed.</p>
  <p>If you want to convince yourself that the Cipher function is working properly internally (and you
    should!), NIST provide test vectors for AES (appendix C.1 of the standard). Click<br>
    &nbsp;&nbsp;&nbsp;&nbsp;
    <button onclick="alert(byteArrayToHexStr(Aes.cipher([0x00,0x11,0x22,0x33,0x44,0x55,0x66,0x77,0x88,0x99,0xaa,0xbb,0xcc,0xdd,0xee,0xff],          Aes.keyExpansion([0x00,0x01,0x02,0x03,0x04,0x05,0x06,0x07,0x08,0x09,0x0a,0x0b,0x0c,0x0d,0x0e,0x0f]))))"> 128-bit
    Test Vector </button>
    <button onclick="alert(byteArrayToHexStr(Aes.cipher([0x00,0x11,0x22,0x33,0x44,0x55,0x66,0x77,0x88,0x99,0xaa,0xbb,0xcc,0xdd,0xee,0xff],          Aes.keyExpansion([0x00,0x01,0x02,0x03,0x04,0x05,0x06,0x07,0x08,0x09,0x0a,0x0b,0x0c,0x0d,0x0e,0x0f, 0x10,0x11,0x12,0x13,0x14,0x15,0x16,0x17]))))"> 192-bit
    Test Vector </button>
    <button onclick="alert(byteArrayToHexStr(Aes.cipher([0x00,0x11,0x22,0x33,0x44,0x55,0x66,0x77,0x88,0x99,0xaa,0xbb,0xcc,0xdd,0xee,0xff],          Aes.keyExpansion([0x00,0x01,0x02,0x03,0x04,0x05,0x06,0x07,0x08,0x09,0x0a,0x0b,0x0c,0x0d,0x0e,0x0f, 0x10,0x11,0x12,0x13,0x14,0x15,0x16,0x17,0x18,0x19,0x1a,0x1b,0x1c,0x1d,0x1e,0x1f]))))"> 256-bit
    Test Vector </button>
    <br>
    and the cipher output block should be</p>
  <ul>
    <li>128-bit: <i>69 c4 e0 d8 6a 7b 04 30 d8 cd b7 80 70 b4 c5 5a</i> </li>
    <li>192-bit: <i>dd a9 7c a4 86 4c df e0 6e af 70 a0 ec 0d 71 91</i> </li>
    <li>256-bit: <i>8e a2 b7 ca 51 67 45 bf ea fc 49 90 4b 49 60 89</i> </li>
  </ul>
  <p>(In counter mode, a text could decrypt correctly even if the cipher routine was flawed).</p>
  <p>The Inverse Cipher is largely a mirror of the Cipher routine, with parallel functions for Cipher,
    SubBytes and ShiftRows. The MixColumns routine is slightly more complex in the inverse. I have not
    implemented the inverse cipher here as it is not required in counter mode.</p>
  <hr>
  <p id="counter-mode"><b>Counter mode of operation</b>: the AES standard concerns itself with numeric or binary data (Rijndael,
    along with most other encryption algorithms, works on a fixed-size block of numbers – in the case
    of AES, each block is 128 bits or 16 bytes).</p>
  <p>In order to make use of it to encrypt real things (such as texts), it has to be used within a certain
    ‘<a target="_blank" href="http://en.wikipedia.org/wiki/Block_cipher_modes_of_operation">mode of operation</a>’.
    This is the interface between text or files, and the purely numerical encryption algorithm. See NIST
    Special Publication <a target="_blank" href="http://csrc.nist.gov/publications/PubsSPs.html#800-38A">SP800-38A</a> for
    more details and test vectors. </p>
  <p>The simplest mode of operation (‘electronic codebook’) encrypts a text block-by-block – but since
    the same block of plaintext will always generate the same block of ciphertext, this can leave too
    many clues for attackers. </p>
  <p>In the ‘<a target="_blank" href="http://en.wikipedia.org/wiki/Counter_mode#Counter_.28CTR.29">counter
      mode</a>’ used in this implementation, a counter which changes with each block is first encrypted,
      and the result is bitwise <span class="small-caps">xor</span>’d with the plaintext block to
      get the ciphertext block (so the plaintext is not actually directly encrypted). A unique ‘<a target="_blank" href="http://en.wikipedia.org/wiki/Cryptographic_nonce">nonce</a>’
      is incorporated in the counter to ensure different ciphertexts are always generated from the
      same plaintext every time it is encrypted; this number is stored at the head of the ciphertext
      to enable decryption. A combination of seconds since 1 Jan 1970, a millisecond-timestamp, and
      a sub-millisecond random number gives a very effective nonce. (To resist cryptographic attacks,
      the nonce does not need to be secret or unpredictable, but it is imperative that it is unique).
      In this implementation, the initial block holds the nonce in the first 8 bytes, and the block
      count in the second 8 bytes. Since JavaScript can represent integers up to 2<sup>53</sup>,
      this allows a message size up to 2<sup>57</sup> (c.
      10<sup>17</sup>)
      bytes – unlikely to be a limitation! Note that the nonce in counter mode is the equivalent
      of the  initialisation vector (<a target="_blank" href="http://en.wikipedia.org/wiki/Initialization_vector">IV</a>)
      in other  modes of operation.</p>
<p>A curious quality of counter mode is that decryption also uses the cipher algorithm rather than
    the inverse-cipher algorithm. Though simple to implement, it has been established to be very secure.</p>
  <p>Encrypting texts or files require not just the mode of operation. When implementing AES, you have
    to consider</p>
  <ul>
    <li>mode of operation; here the Counter (<span class="small-caps">ctr</span>) mode of operation –
      both simple to implement, and very secure</li>
    <li>conversion of text (including multi-byte Unicode texts) to binary/numeric data; here multi-byte
      Unicode characters are converted to <a target="_blank" href="http://en.wikipedia.org/wiki/Utf8">UTF8</a>,
      then the numeric character codes are used to pass to the cipher routine</li>
    <li>conversion of encrypted data to values which can be stored or transmitted without problem; here
      the binary encrypted texts are encoded in <a target="_blank" href="http://en.wikipedia.org/wiki/Base64">Base64</a>,
      which is a very safe 7-bit encoding with no control codes or other troublesome characters.</li>
  </ul>
  <p>The <b>key</b> in this script is obtained by applying the Cipher routine to encrypt the first
    16/24/32 characters of the password (for 128-/192-/256-bit keys) to make the key. This is a
    convenient way to obtain a secure key within an entirely self-contained script (in a production
    environment, as opposed to this essentially tutorial code, the key might be generated
    as a <a href="http://www.movable-type.co.uk/scripts/sha256.html">hash</a>, e.g. simply <code>key = Sha256(password)</code>).
    In more detail, the supplied password is  converted to to UTF-8 (to be byte-safe),      then
    the first 16/24/32 characters are converted to bytes. The resulting pwBytes is used as a seed
    for the Aes.keyExpansion() which is then used as the key to encrypt pwBytes with Aes.cipher().
    Examples of keys generated in this way from (unrealistically) simple passwords:</p>
<table style="margin-left: 4em">
    <tbody><tr>
      <td>‘a’ (U+0061): </td>
      <td class="align-right">pwBytes = </td>
      <td class="code">61 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00</td>
    </tr>
    <tr>
      <td> </td>
      <td class="align-right">key =</td>
      <td class="code">60 84 dd 49 14 7b 5d 05 7a e3 f8 81 b9 0e e7 dd</td>
    </tr>
    <tr>
      <td>‘b’ (U+0062): </td>
      <td class="align-right">pwBytes =</td>
      <td class="code">62 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00</td>
    </tr>
    <tr>
      <td> </td>
      <td class="align-right">key =</td>
      <td class="code">b4 1a 83 4f da 4b aa 41 76 62 be d6 2c 66 83 6d</td>
    </tr>
    <tr>
      <td>‘☺’ (U+263a):</td>
      <td class="align-right">pwBytes =</td>
      <td class="code">e2 98 ba 00 00 00 00 00 00 00 00 00 00 00 00 00</td>
    </tr>
    <tr>
      <td> </td>
      <td class="align-right">key =</td>
      <td class="code">d1 0c cd fd 44 45 54 ef 59 aa f8 dc 78 8e 9a 7c</td>
    </tr>
  </tbody></table>
  <p>Even with a single bit difference between two passwords (‘a’ and ‘b’), the key is entirely different.</p>
  <p>&nbsp;</p>
<p><b>Usage</b>: this implementation would be invoked as follows:</p>
  <pre class="prettyprint"><span class="pln">  </span><span class="kwd">var</span><span class="pln"> password </span><span class="pun">=</span><span class="pln"> </span><span class="str">'L0ck it up saf3'</span><span class="pun">;</span><span class="pln">
  </span><span class="kwd">var</span><span class="pln"> plaintext </span><span class="pun">=</span><span class="pln"> </span><span class="str">'pssst ... đon’t tell anyøne!'</span><span class="pun">;</span><span class="pln">
  </span><span class="kwd">var</span><span class="pln"> ciphertext </span><span class="pun">=</span><span class="pln"> </span><span class="typ">Aes</span><span class="pun">.</span><span class="typ">Ctr</span><span class="pun">.</span><span class="pln">encrypt</span><span class="pun">(</span><span class="pln">plaintext</span><span class="pun">,</span><span class="pln"> password</span><span class="pun">,</span><span class="pln"> </span><span class="lit">256</span><span class="pun">);</span><span class="pln">
  </span><span class="kwd">var</span><span class="pln"> origtext </span><span class="pun">=</span><span class="pln"> </span><span class="typ">Aes</span><span class="pun">.</span><span class="typ">Ctr</span><span class="pun">.</span><span class="pln">decrypt</span><span class="pun">(</span><span class="pln">ciphertext</span><span class="pun">,</span><span class="pln"> password</span><span class="pun">,</span><span class="pln"> </span><span class="lit">256</span><span class="pun">);</span><span class="pln">
  </span></pre>
  <hr>
  <p id="js"><i>Does it make sense to implement AES in JavaScript?</i> Sometimes JavaScript can be used for real-world
    cryptographic applications (particularly web-based ones). And a JavaScript implementation, which
    anyone can play around with, can provide an easy starting-point for implementation in other languages.
    Though I still think that <a href="http://www.movable-type.co.uk/scripts/tea-block.html">TEA</a> is generally good enough for simple applications,
    and a great deal simpler to use (as well as significantly faster, according to <a target="_blank" href="http://jsperf.com/encryption-decryption-comparisons">tests</a> by Tom Doan, thanks Tom).</p>
  <p>The test vectors have been confirmed in IE 6 &amp; 7 (Win), FF 2 &amp; 3 (Win), Safari 2 (Mac),
    Opera 9 (Linux), and Konqueror 3 (Linux) (thx Jon Passki, Vincenzo Buttazzo). If you can confirm
    any other versions (or find any problems), please let me know! </p>
  <p><i>In other languages:</i> I’ve developed a <a href="http://www.movable-type.co.uk/scripts/aes-php.html">PHP version</a> which directly
    mirrors this JavaScript version; it differs in that PHP has Base64 encoding and UTF-8 encoding built-in,
    and has no unsigned-right-shift operator(!), but is otherwise a straightforward port. In other languages,
    be sure to use 64-bit integers/longs, either unsigned or with unsigned right-shift operators; you
    may need to take into consideration the way different languages handle bitwise ops, and of course
    standard issues such as array handling and strict typing. I’m not aware of any other issues. <br>
&nbsp;&nbsp;&nbsp;&nbsp;I’m not familiar with Python, but there is a Python version available at <a target="_blank" href="http://wiki.birth-online.de/snippets/python/aes-rijndael">wiki.birth-online.de/snippets/python/aes-rijndael</a>.</p>
  <p><i>Speed:</i> as mentioned, this is not an optimised implementation – on a 2GHz Intel Core 2 machine,
    this implementation processes around 6kB/sec using IE7, and 30kB/sec using FF3(!) (one page of text
    at a standard 250 words is about 1.5kB). The 128-bit version is some 25% faster than the 256-bit
    version. </p>
  <p>For more information, have a look at</p>
  <ul>
    <li>Daemen &amp; Rijnael’s<a target="_blank" href="http://csrc.nist.gov/archive/aes/rijndael/Rijndael-ammended.pdf"> AES
        proposal</a> for Rijndael Block Cipher</li>
    <li><a target="_blank" href="http://en.wikipedia.org/wiki/Advanced_Encryption_Standard">Wikipedia</a> article</li>
    <!-- <li>Cryptomathic article <a href="http://www.cryptomathic.it/company/aes.html"><i>Do 
          We Need AES?</i></a></li> -->
    <li>article from John Savard’s <a target="_blank" href="http://www.quadibloc.com/crypto/co040401.htm">Cryptographic
        Compendium</a></li>
  </ul>
  <p>For some security applications, a cryptographic hash is more appropriate than encryption – if
    you are interested in a hash function, see my implementations of <a href="http://www.movable-type.co.uk/scripts/sha1.html">SHA-1</a>
    and <a href="http://www.movable-type.co.uk/scripts/sha256.html">SHA-256</a>.</p>
<p><i>October 2009</i>: I have updated the formulation of these scripts to use JavaScript <a href="http://www.movable-type.co.uk/scripts/namespaces.html">namespaces</a> for better
    encapsulation of function names.</p>
  <hr class="fullwidth">
  <p id="postscript">See below for the source code of the JavaScript implementation. §ection numbers relate the code back
    to sections in the standard. </p>
  <p id="licence"><a target="_blank" href="http://creativecommons.org/licenses/by/3.0/" style="float:right"><img alt="Creative Commons License" style="margin:4px" src="JavaScript%20Implementation%20of%20AES%20Advanced%20Encryption%20Standard%20in%20Counter%20Mode%20_%20Movable%20Type%20Scripts_files/88x31.png"></a>I 
    offer these formulæ &amp; scripts for free use and adaptation as my
    contribution to the open-source info-sphere from which I have received so much. You are welcome to
    re-use these scripts [under a simple <a target="_blank" href="http://creativecommons.org/licenses/by/3.0/">attribution</a> license,
    without any warranty express or implied] provided solely that you retain my copyright notice and
    a link to this page.</p>
  <p><a target="_blank" href="https://www.paypal.com/cgi-bin/webscr?cmd=_s-xclick&amp;hosted_button_id=3737803" style="float: right;"><img alt="Paypal donation" style="margin: 4px;" src="JavaScript%20Implementation%20of%20AES%20Advanced%20Encryption%20Standard%20in%20Counter%20Mode%20_%20Movable%20Type%20Scripts_files/btn_donate_SM.gif"></a>
    If you would like to show your appreciation and support continued 
development of these scripts, I would most gratefully accept 
    <a target="_blank" href="https://www.paypal.com/cgi-bin/webscr?cmd=_s-xclick&amp;hosted_button_id=3737803" title="Thank you!">donations</a>.</p>
  <p>Note: this script was <b>revised</b> on <b>1 August 2008</b> to use <b>Base64 encoding</b> – the
    previous version, which used less standard encoding, is <a href="http://www.movable-type.co.uk/scripts/aes-old.html">still available</a> if
    you have need to refer back to it.</p>
  <p>If you have any queries or find any problems, contact me at <span class="rtl"><a href="mailto:scripts-enc@movable-type.co.uk" rel="nofollow">ku.oc.epyt-elbavom@cne-stpircs</a></span>.</p>
  <p><span class="note"><i>© 2005-2012 Chris Veness</i></span> </p>
  <hr class="fullwidth">
  <pre class="fullwidth prettyprint" id="code"><span class="com">/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -  */</span><span class="pln">
</span><span class="com">/*  AES implementation in JavaScript (c) Chris Veness 2005-2012                                   */</span><span class="pln">
</span><span class="com">/*   - see http://csrc.nist.gov/publications/PubsFIPS.html#197                                    */</span><span class="pln">
</span><span class="com">/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -  */</span><span class="pln">

</span><span class="kwd">var</span><span class="pln"> </span><span class="typ">Aes</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="pun">{};</span><span class="pln">  </span><span class="com">// Aes namespace</span><span class="pln">

</span><span class="com">/**
 * AES Cipher function: encrypt 'input' state with Rijndael algorithm
 *   applies Nr rounds (10/12/14) using key schedule w for 'add round key' stage
 *
 * @param {Number[]} input 16-byte (128-bit) input state array
 * @param {Number[][]} w   Key schedule as 2D byte-array (Nr+1 x Nb bytes)
 * @returns {Number[]}     Encrypted output state array
 */</span><span class="pln">
</span><span class="typ">Aes</span><span class="pun">.</span><span class="pln">cipher </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">(</span><span class="pln">input</span><span class="pun">,</span><span class="pln"> w</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">    </span><span class="com">// main Cipher function [§5.1]</span><span class="pln">
  </span><span class="kwd">var</span><span class="pln"> </span><span class="typ">Nb</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="lit">4</span><span class="pun">;</span><span class="pln">               </span><span class="com">// block size (in words): no of columns in state (fixed at 4 for AES)</span><span class="pln">
  </span><span class="kwd">var</span><span class="pln"> </span><span class="typ">Nr</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> w</span><span class="pun">.</span><span class="pln">length</span><span class="pun">/</span><span class="typ">Nb</span><span class="pln"> </span><span class="pun">-</span><span class="pln"> </span><span class="lit">1</span><span class="pun">;</span><span class="pln"> </span><span class="com">// no of rounds: 10/12/14 for 128/192/256-bit keys</span><span class="pln">

  </span><span class="kwd">var</span><span class="pln"> state </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[[],[],[],[]];</span><span class="pln">  </span><span class="com">// initialise 4xNb byte-array 'state' with input [§3.4]</span><span class="pln">
  </span><span class="kwd">for</span><span class="pln"> </span><span class="pun">(</span><span class="kwd">var</span><span class="pln"> i</span><span class="pun">=</span><span class="lit">0</span><span class="pun">;</span><span class="pln"> i</span><span class="pun">&lt;</span><span class="lit">4</span><span class="pun">*</span><span class="typ">Nb</span><span class="pun">;</span><span class="pln"> i</span><span class="pun">++)</span><span class="pln"> state</span><span class="pun">[</span><span class="pln">i</span><span class="pun">%</span><span class="lit">4</span><span class="pun">][</span><span class="typ">Math</span><span class="pun">.</span><span class="pln">floor</span><span class="pun">(</span><span class="pln">i</span><span class="pun">/</span><span class="lit">4</span><span class="pun">)]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> input</span><span class="pun">[</span><span class="pln">i</span><span class="pun">];</span><span class="pln">

  state </span><span class="pun">=</span><span class="pln"> </span><span class="typ">Aes</span><span class="pun">.</span><span class="pln">addRoundKey</span><span class="pun">(</span><span class="pln">state</span><span class="pun">,</span><span class="pln"> w</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0</span><span class="pun">,</span><span class="pln"> </span><span class="typ">Nb</span><span class="pun">);</span><span class="pln">

  </span><span class="kwd">for</span><span class="pln"> </span><span class="pun">(</span><span class="kwd">var</span><span class="pln"> round</span><span class="pun">=</span><span class="lit">1</span><span class="pun">;</span><span class="pln"> round</span><span class="pun">&lt;</span><span class="typ">Nr</span><span class="pun">;</span><span class="pln"> round</span><span class="pun">++)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
    state </span><span class="pun">=</span><span class="pln"> </span><span class="typ">Aes</span><span class="pun">.</span><span class="pln">subBytes</span><span class="pun">(</span><span class="pln">state</span><span class="pun">,</span><span class="pln"> </span><span class="typ">Nb</span><span class="pun">);</span><span class="pln">
    state </span><span class="pun">=</span><span class="pln"> </span><span class="typ">Aes</span><span class="pun">.</span><span class="pln">shiftRows</span><span class="pun">(</span><span class="pln">state</span><span class="pun">,</span><span class="pln"> </span><span class="typ">Nb</span><span class="pun">);</span><span class="pln">
    state </span><span class="pun">=</span><span class="pln"> </span><span class="typ">Aes</span><span class="pun">.</span><span class="pln">mixColumns</span><span class="pun">(</span><span class="pln">state</span><span class="pun">,</span><span class="pln"> </span><span class="typ">Nb</span><span class="pun">);</span><span class="pln">
    state </span><span class="pun">=</span><span class="pln"> </span><span class="typ">Aes</span><span class="pun">.</span><span class="pln">addRoundKey</span><span class="pun">(</span><span class="pln">state</span><span class="pun">,</span><span class="pln"> w</span><span class="pun">,</span><span class="pln"> round</span><span class="pun">,</span><span class="pln"> </span><span class="typ">Nb</span><span class="pun">);</span><span class="pln">
  </span><span class="pun">}</span><span class="pln">

  state </span><span class="pun">=</span><span class="pln"> </span><span class="typ">Aes</span><span class="pun">.</span><span class="pln">subBytes</span><span class="pun">(</span><span class="pln">state</span><span class="pun">,</span><span class="pln"> </span><span class="typ">Nb</span><span class="pun">);</span><span class="pln">
  state </span><span class="pun">=</span><span class="pln"> </span><span class="typ">Aes</span><span class="pun">.</span><span class="pln">shiftRows</span><span class="pun">(</span><span class="pln">state</span><span class="pun">,</span><span class="pln"> </span><span class="typ">Nb</span><span class="pun">);</span><span class="pln">
  state </span><span class="pun">=</span><span class="pln"> </span><span class="typ">Aes</span><span class="pun">.</span><span class="pln">addRoundKey</span><span class="pun">(</span><span class="pln">state</span><span class="pun">,</span><span class="pln"> w</span><span class="pun">,</span><span class="pln"> </span><span class="typ">Nr</span><span class="pun">,</span><span class="pln"> </span><span class="typ">Nb</span><span class="pun">);</span><span class="pln">

  </span><span class="kwd">var</span><span class="pln"> output </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">Array</span><span class="pun">(</span><span class="lit">4</span><span class="pun">*</span><span class="typ">Nb</span><span class="pun">);</span><span class="pln">  </span><span class="com">// convert state to 1-d array before returning [§3.4]</span><span class="pln">
  </span><span class="kwd">for</span><span class="pln"> </span><span class="pun">(</span><span class="kwd">var</span><span class="pln"> i</span><span class="pun">=</span><span class="lit">0</span><span class="pun">;</span><span class="pln"> i</span><span class="pun">&lt;</span><span class="lit">4</span><span class="pun">*</span><span class="typ">Nb</span><span class="pun">;</span><span class="pln"> i</span><span class="pun">++)</span><span class="pln"> output</span><span class="pun">[</span><span class="pln">i</span><span class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> state</span><span class="pun">[</span><span class="pln">i</span><span class="pun">%</span><span class="lit">4</span><span class="pun">][</span><span class="typ">Math</span><span class="pun">.</span><span class="pln">floor</span><span class="pun">(</span><span class="pln">i</span><span class="pun">/</span><span class="lit">4</span><span class="pun">)];</span><span class="pln">
  </span><span class="kwd">return</span><span class="pln"> output</span><span class="pun">;</span><span class="pln">
</span><span class="pun">}</span><span class="pln">

</span><span class="com">/**
 * Perform Key Expansion to generate a Key Schedule
 *
 * @param {Number[]} key Key as 16/24/32-byte array
 * @returns {Number[][]} Expanded key schedule as 2D byte-array (Nr+1 x Nb bytes)
 */</span><span class="pln">
</span><span class="typ">Aes</span><span class="pun">.</span><span class="pln">keyExpansion </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">(</span><span class="pln">key</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">  </span><span class="com">// generate Key Schedule (byte-array Nr+1 x Nb) from Key [§5.2]</span><span class="pln">
  </span><span class="kwd">var</span><span class="pln"> </span><span class="typ">Nb</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="lit">4</span><span class="pun">;</span><span class="pln">            </span><span class="com">// block size (in words): no of columns in state (fixed at 4 for AES)</span><span class="pln">
  </span><span class="kwd">var</span><span class="pln"> </span><span class="typ">Nk</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> key</span><span class="pun">.</span><span class="pln">length</span><span class="pun">/</span><span class="lit">4</span><span class="pln">  </span><span class="com">// key length (in words): 4/6/8 for 128/192/256-bit keys</span><span class="pln">
  </span><span class="kwd">var</span><span class="pln"> </span><span class="typ">Nr</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="typ">Nk</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> </span><span class="lit">6</span><span class="pun">;</span><span class="pln">       </span><span class="com">// no of rounds: 10/12/14 for 128/192/256-bit keys</span><span class="pln">

  </span><span class="kwd">var</span><span class="pln"> w </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">Array</span><span class="pun">(</span><span class="typ">Nb</span><span class="pun">*(</span><span class="typ">Nr</span><span class="pun">+</span><span class="lit">1</span><span class="pun">));</span><span class="pln">
  </span><span class="kwd">var</span><span class="pln"> temp </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">Array</span><span class="pun">(</span><span class="lit">4</span><span class="pun">);</span><span class="pln">

  </span><span class="kwd">for</span><span class="pln"> </span><span class="pun">(</span><span class="kwd">var</span><span class="pln"> i</span><span class="pun">=</span><span class="lit">0</span><span class="pun">;</span><span class="pln"> i</span><span class="pun">&lt;</span><span class="typ">Nk</span><span class="pun">;</span><span class="pln"> i</span><span class="pun">++)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
    </span><span class="kwd">var</span><span class="pln"> r </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[</span><span class="pln">key</span><span class="pun">[</span><span class="lit">4</span><span class="pun">*</span><span class="pln">i</span><span class="pun">],</span><span class="pln"> key</span><span class="pun">[</span><span class="lit">4</span><span class="pun">*</span><span class="pln">i</span><span class="pun">+</span><span class="lit">1</span><span class="pun">],</span><span class="pln"> key</span><span class="pun">[</span><span class="lit">4</span><span class="pun">*</span><span class="pln">i</span><span class="pun">+</span><span class="lit">2</span><span class="pun">],</span><span class="pln"> key</span><span class="pun">[</span><span class="lit">4</span><span class="pun">*</span><span class="pln">i</span><span class="pun">+</span><span class="lit">3</span><span class="pun">]];</span><span class="pln">
    w</span><span class="pun">[</span><span class="pln">i</span><span class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> r</span><span class="pun">;</span><span class="pln">
  </span><span class="pun">}</span><span class="pln">

  </span><span class="kwd">for</span><span class="pln"> </span><span class="pun">(</span><span class="kwd">var</span><span class="pln"> i</span><span class="pun">=</span><span class="typ">Nk</span><span class="pun">;</span><span class="pln"> i</span><span class="pun">&lt;(</span><span class="typ">Nb</span><span class="pun">*(</span><span class="typ">Nr</span><span class="pun">+</span><span class="lit">1</span><span class="pun">));</span><span class="pln"> i</span><span class="pun">++)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
    w</span><span class="pun">[</span><span class="pln">i</span><span class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">Array</span><span class="pun">(</span><span class="lit">4</span><span class="pun">);</span><span class="pln">
    </span><span class="kwd">for</span><span class="pln"> </span><span class="pun">(</span><span class="kwd">var</span><span class="pln"> t</span><span class="pun">=</span><span class="lit">0</span><span class="pun">;</span><span class="pln"> t</span><span class="pun">&lt;</span><span class="lit">4</span><span class="pun">;</span><span class="pln"> t</span><span class="pun">++)</span><span class="pln"> temp</span><span class="pun">[</span><span class="pln">t</span><span class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> w</span><span class="pun">[</span><span class="pln">i</span><span class="pun">-</span><span class="lit">1</span><span class="pun">][</span><span class="pln">t</span><span class="pun">];</span><span class="pln">
    </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">i </span><span class="pun">%</span><span class="pln"> </span><span class="typ">Nk</span><span class="pln"> </span><span class="pun">==</span><span class="pln"> </span><span class="lit">0</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
      temp </span><span class="pun">=</span><span class="pln"> </span><span class="typ">Aes</span><span class="pun">.</span><span class="pln">subWord</span><span class="pun">(</span><span class="typ">Aes</span><span class="pun">.</span><span class="pln">rotWord</span><span class="pun">(</span><span class="pln">temp</span><span class="pun">));</span><span class="pln">
      </span><span class="kwd">for</span><span class="pln"> </span><span class="pun">(</span><span class="kwd">var</span><span class="pln"> t</span><span class="pun">=</span><span class="lit">0</span><span class="pun">;</span><span class="pln"> t</span><span class="pun">&lt;</span><span class="lit">4</span><span class="pun">;</span><span class="pln"> t</span><span class="pun">++)</span><span class="pln"> temp</span><span class="pun">[</span><span class="pln">t</span><span class="pun">]</span><span class="pln"> </span><span class="pun">^=</span><span class="pln"> </span><span class="typ">Aes</span><span class="pun">.</span><span class="pln">rCon</span><span class="pun">[</span><span class="pln">i</span><span class="pun">/</span><span class="typ">Nk</span><span class="pun">][</span><span class="pln">t</span><span class="pun">];</span><span class="pln">
    </span><span class="pun">}</span><span class="pln"> </span><span class="kwd">else</span><span class="pln"> </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="typ">Nk</span><span class="pln"> </span><span class="pun">&gt;</span><span class="pln"> </span><span class="lit">6</span><span class="pln"> </span><span class="pun">&amp;&amp;</span><span class="pln"> i</span><span class="pun">%</span><span class="typ">Nk</span><span class="pln"> </span><span class="pun">==</span><span class="pln"> </span><span class="lit">4</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
      temp </span><span class="pun">=</span><span class="pln"> </span><span class="typ">Aes</span><span class="pun">.</span><span class="pln">subWord</span><span class="pun">(</span><span class="pln">temp</span><span class="pun">);</span><span class="pln">
    </span><span class="pun">}</span><span class="pln">
    </span><span class="kwd">for</span><span class="pln"> </span><span class="pun">(</span><span class="kwd">var</span><span class="pln"> t</span><span class="pun">=</span><span class="lit">0</span><span class="pun">;</span><span class="pln"> t</span><span class="pun">&lt;</span><span class="lit">4</span><span class="pun">;</span><span class="pln"> t</span><span class="pun">++)</span><span class="pln"> w</span><span class="pun">[</span><span class="pln">i</span><span class="pun">][</span><span class="pln">t</span><span class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> w</span><span class="pun">[</span><span class="pln">i</span><span class="pun">-</span><span class="typ">Nk</span><span class="pun">][</span><span class="pln">t</span><span class="pun">]</span><span class="pln"> </span><span class="pun">^</span><span class="pln"> temp</span><span class="pun">[</span><span class="pln">t</span><span class="pun">];</span><span class="pln">
  </span><span class="pun">}</span><span class="pln">

  </span><span class="kwd">return</span><span class="pln"> w</span><span class="pun">;</span><span class="pln">
</span><span class="pun">}</span><span class="pln">

</span><span class="com">/*
 * ---- remaining routines are private, not called externally ----
 */</span><span class="pln">
 
</span><span class="typ">Aes</span><span class="pun">.</span><span class="pln">subBytes </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">(</span><span class="pln">s</span><span class="pun">,</span><span class="pln"> </span><span class="typ">Nb</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">    </span><span class="com">// apply SBox to state S [§5.1.1]</span><span class="pln">
  </span><span class="kwd">for</span><span class="pln"> </span><span class="pun">(</span><span class="kwd">var</span><span class="pln"> r</span><span class="pun">=</span><span class="lit">0</span><span class="pun">;</span><span class="pln"> r</span><span class="pun">&lt;</span><span class="lit">4</span><span class="pun">;</span><span class="pln"> r</span><span class="pun">++)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
    </span><span class="kwd">for</span><span class="pln"> </span><span class="pun">(</span><span class="kwd">var</span><span class="pln"> c</span><span class="pun">=</span><span class="lit">0</span><span class="pun">;</span><span class="pln"> c</span><span class="pun">&lt;</span><span class="typ">Nb</span><span class="pun">;</span><span class="pln"> c</span><span class="pun">++)</span><span class="pln"> s</span><span class="pun">[</span><span class="pln">r</span><span class="pun">][</span><span class="pln">c</span><span class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="typ">Aes</span><span class="pun">.</span><span class="pln">sBox</span><span class="pun">[</span><span class="pln">s</span><span class="pun">[</span><span class="pln">r</span><span class="pun">][</span><span class="pln">c</span><span class="pun">]];</span><span class="pln">
  </span><span class="pun">}</span><span class="pln">
  </span><span class="kwd">return</span><span class="pln"> s</span><span class="pun">;</span><span class="pln">
</span><span class="pun">}</span><span class="pln">

</span><span class="typ">Aes</span><span class="pun">.</span><span class="pln">shiftRows </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">(</span><span class="pln">s</span><span class="pun">,</span><span class="pln"> </span><span class="typ">Nb</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">    </span><span class="com">// shift row r of state S left by r bytes [§5.1.2]</span><span class="pln">
  </span><span class="kwd">var</span><span class="pln"> t </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">Array</span><span class="pun">(</span><span class="lit">4</span><span class="pun">);</span><span class="pln">
  </span><span class="kwd">for</span><span class="pln"> </span><span class="pun">(</span><span class="kwd">var</span><span class="pln"> r</span><span class="pun">=</span><span class="lit">1</span><span class="pun">;</span><span class="pln"> r</span><span class="pun">&lt;</span><span class="lit">4</span><span class="pun">;</span><span class="pln"> r</span><span class="pun">++)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
    </span><span class="kwd">for</span><span class="pln"> </span><span class="pun">(</span><span class="kwd">var</span><span class="pln"> c</span><span class="pun">=</span><span class="lit">0</span><span class="pun">;</span><span class="pln"> c</span><span class="pun">&lt;</span><span class="lit">4</span><span class="pun">;</span><span class="pln"> c</span><span class="pun">++)</span><span class="pln"> t</span><span class="pun">[</span><span class="pln">c</span><span class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> s</span><span class="pun">[</span><span class="pln">r</span><span class="pun">][(</span><span class="pln">c</span><span class="pun">+</span><span class="pln">r</span><span class="pun">)%</span><span class="typ">Nb</span><span class="pun">];</span><span class="pln">  </span><span class="com">// shift into temp copy</span><span class="pln">
    </span><span class="kwd">for</span><span class="pln"> </span><span class="pun">(</span><span class="kwd">var</span><span class="pln"> c</span><span class="pun">=</span><span class="lit">0</span><span class="pun">;</span><span class="pln"> c</span><span class="pun">&lt;</span><span class="lit">4</span><span class="pun">;</span><span class="pln"> c</span><span class="pun">++)</span><span class="pln"> s</span><span class="pun">[</span><span class="pln">r</span><span class="pun">][</span><span class="pln">c</span><span class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> t</span><span class="pun">[</span><span class="pln">c</span><span class="pun">];</span><span class="pln">         </span><span class="com">// and copy back</span><span class="pln">
  </span><span class="pun">}</span><span class="pln">          </span><span class="com">// note that this will work for Nb=4,5,6, but not 7,8 (always 4 for AES):</span><span class="pln">
  </span><span class="kwd">return</span><span class="pln"> s</span><span class="pun">;</span><span class="pln">  </span><span class="com">// see asmaes.sourceforge.net/rijndael/rijndaelImplementation.pdf</span><span class="pln">
</span><span class="pun">}</span><span class="pln">

</span><span class="typ">Aes</span><span class="pun">.</span><span class="pln">mixColumns </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">(</span><span class="pln">s</span><span class="pun">,</span><span class="pln"> </span><span class="typ">Nb</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">   </span><span class="com">// combine bytes of each col of state S [§5.1.3]</span><span class="pln">
  </span><span class="kwd">for</span><span class="pln"> </span><span class="pun">(</span><span class="kwd">var</span><span class="pln"> c</span><span class="pun">=</span><span class="lit">0</span><span class="pun">;</span><span class="pln"> c</span><span class="pun">&lt;</span><span class="lit">4</span><span class="pun">;</span><span class="pln"> c</span><span class="pun">++)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
    </span><span class="kwd">var</span><span class="pln"> a </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">Array</span><span class="pun">(</span><span class="lit">4</span><span class="pun">);</span><span class="pln">  </span><span class="com">// 'a' is a copy of the current column from 's'</span><span class="pln">
    </span><span class="kwd">var</span><span class="pln"> b </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">Array</span><span class="pun">(</span><span class="lit">4</span><span class="pun">);</span><span class="pln">  </span><span class="com">// 'b' is a•{02} in GF(2^8)</span><span class="pln">
    </span><span class="kwd">for</span><span class="pln"> </span><span class="pun">(</span><span class="kwd">var</span><span class="pln"> i</span><span class="pun">=</span><span class="lit">0</span><span class="pun">;</span><span class="pln"> i</span><span class="pun">&lt;</span><span class="lit">4</span><span class="pun">;</span><span class="pln"> i</span><span class="pun">++)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
      a</span><span class="pun">[</span><span class="pln">i</span><span class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> s</span><span class="pun">[</span><span class="pln">i</span><span class="pun">][</span><span class="pln">c</span><span class="pun">];</span><span class="pln">
      b</span><span class="pun">[</span><span class="pln">i</span><span class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> s</span><span class="pun">[</span><span class="pln">i</span><span class="pun">][</span><span class="pln">c</span><span class="pun">]&amp;</span><span class="lit">0x80</span><span class="pln"> </span><span class="pun">?</span><span class="pln"> s</span><span class="pun">[</span><span class="pln">i</span><span class="pun">][</span><span class="pln">c</span><span class="pun">]&lt;&lt;</span><span class="lit">1</span><span class="pln"> </span><span class="pun">^</span><span class="pln"> </span><span class="lit">0x011b</span><span class="pln"> </span><span class="pun">:</span><span class="pln"> s</span><span class="pun">[</span><span class="pln">i</span><span class="pun">][</span><span class="pln">c</span><span class="pun">]&lt;&lt;</span><span class="lit">1</span><span class="pun">;</span><span class="pln">

    </span><span class="pun">}</span><span class="pln">
    </span><span class="com">// a[n] ^ b[n] is a•{03} in GF(2^8)</span><span class="pln">
    s</span><span class="pun">[</span><span class="lit">0</span><span class="pun">][</span><span class="pln">c</span><span class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> b</span><span class="pun">[</span><span class="lit">0</span><span class="pun">]</span><span class="pln"> </span><span class="pun">^</span><span class="pln"> a</span><span class="pun">[</span><span class="lit">1</span><span class="pun">]</span><span class="pln"> </span><span class="pun">^</span><span class="pln"> b</span><span class="pun">[</span><span class="lit">1</span><span class="pun">]</span><span class="pln"> </span><span class="pun">^</span><span class="pln"> a</span><span class="pun">[</span><span class="lit">2</span><span class="pun">]</span><span class="pln"> </span><span class="pun">^</span><span class="pln"> a</span><span class="pun">[</span><span class="lit">3</span><span class="pun">];</span><span class="pln"> </span><span class="com">// 2*a0 + 3*a1 + a2 + a3</span><span class="pln">
    s</span><span class="pun">[</span><span class="lit">1</span><span class="pun">][</span><span class="pln">c</span><span class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> a</span><span class="pun">[</span><span class="lit">0</span><span class="pun">]</span><span class="pln"> </span><span class="pun">^</span><span class="pln"> b</span><span class="pun">[</span><span class="lit">1</span><span class="pun">]</span><span class="pln"> </span><span class="pun">^</span><span class="pln"> a</span><span class="pun">[</span><span class="lit">2</span><span class="pun">]</span><span class="pln"> </span><span class="pun">^</span><span class="pln"> b</span><span class="pun">[</span><span class="lit">2</span><span class="pun">]</span><span class="pln"> </span><span class="pun">^</span><span class="pln"> a</span><span class="pun">[</span><span class="lit">3</span><span class="pun">];</span><span class="pln"> </span><span class="com">// a0 * 2*a1 + 3*a2 + a3</span><span class="pln">
    s</span><span class="pun">[</span><span class="lit">2</span><span class="pun">][</span><span class="pln">c</span><span class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> a</span><span class="pun">[</span><span class="lit">0</span><span class="pun">]</span><span class="pln"> </span><span class="pun">^</span><span class="pln"> a</span><span class="pun">[</span><span class="lit">1</span><span class="pun">]</span><span class="pln"> </span><span class="pun">^</span><span class="pln"> b</span><span class="pun">[</span><span class="lit">2</span><span class="pun">]</span><span class="pln"> </span><span class="pun">^</span><span class="pln"> a</span><span class="pun">[</span><span class="lit">3</span><span class="pun">]</span><span class="pln"> </span><span class="pun">^</span><span class="pln"> b</span><span class="pun">[</span><span class="lit">3</span><span class="pun">];</span><span class="pln"> </span><span class="com">// a0 + a1 + 2*a2 + 3*a3</span><span class="pln">
    s</span><span class="pun">[</span><span class="lit">3</span><span class="pun">][</span><span class="pln">c</span><span class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> a</span><span class="pun">[</span><span class="lit">0</span><span class="pun">]</span><span class="pln"> </span><span class="pun">^</span><span class="pln"> b</span><span class="pun">[</span><span class="lit">0</span><span class="pun">]</span><span class="pln"> </span><span class="pun">^</span><span class="pln"> a</span><span class="pun">[</span><span class="lit">1</span><span class="pun">]</span><span class="pln"> </span><span class="pun">^</span><span class="pln"> a</span><span class="pun">[</span><span class="lit">2</span><span class="pun">]</span><span class="pln"> </span><span class="pun">^</span><span class="pln"> b</span><span class="pun">[</span><span class="lit">3</span><span class="pun">];</span><span class="pln"> </span><span class="com">// 3*a0 + a1 + a2 + 2*a3</span><span class="pln">
  </span><span class="pun">}</span><span class="pln">
  </span><span class="kwd">return</span><span class="pln"> s</span><span class="pun">;</span><span class="pln">
</span><span class="pun">}</span><span class="pln">

</span><span class="typ">Aes</span><span class="pun">.</span><span class="pln">addRoundKey </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">(</span><span class="pln">state</span><span class="pun">,</span><span class="pln"> w</span><span class="pun">,</span><span class="pln"> rnd</span><span class="pun">,</span><span class="pln"> </span><span class="typ">Nb</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">  </span><span class="com">// xor Round Key into state S [§5.1.4]</span><span class="pln">
  </span><span class="kwd">for</span><span class="pln"> </span><span class="pun">(</span><span class="kwd">var</span><span class="pln"> r</span><span class="pun">=</span><span class="lit">0</span><span class="pun">;</span><span class="pln"> r</span><span class="pun">&lt;</span><span class="lit">4</span><span class="pun">;</span><span class="pln"> r</span><span class="pun">++)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
    </span><span class="kwd">for</span><span class="pln"> </span><span class="pun">(</span><span class="kwd">var</span><span class="pln"> c</span><span class="pun">=</span><span class="lit">0</span><span class="pun">;</span><span class="pln"> c</span><span class="pun">&lt;</span><span class="typ">Nb</span><span class="pun">;</span><span class="pln"> c</span><span class="pun">++)</span><span class="pln"> state</span><span class="pun">[</span><span class="pln">r</span><span class="pun">][</span><span class="pln">c</span><span class="pun">]</span><span class="pln"> </span><span class="pun">^=</span><span class="pln"> w</span><span class="pun">[</span><span class="pln">rnd</span><span class="pun">*</span><span class="lit">4</span><span class="pun">+</span><span class="pln">c</span><span class="pun">][</span><span class="pln">r</span><span class="pun">];</span><span class="pln">
  </span><span class="pun">}</span><span class="pln">
  </span><span class="kwd">return</span><span class="pln"> state</span><span class="pun">;</span><span class="pln">
</span><span class="pun">}</span><span class="pln">

</span><span class="typ">Aes</span><span class="pun">.</span><span class="pln">subWord </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">(</span><span class="pln">w</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">    </span><span class="com">// apply SBox to 4-byte word w</span><span class="pln">
  </span><span class="kwd">for</span><span class="pln"> </span><span class="pun">(</span><span class="kwd">var</span><span class="pln"> i</span><span class="pun">=</span><span class="lit">0</span><span class="pun">;</span><span class="pln"> i</span><span class="pun">&lt;</span><span class="lit">4</span><span class="pun">;</span><span class="pln"> i</span><span class="pun">++)</span><span class="pln"> w</span><span class="pun">[</span><span class="pln">i</span><span class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="typ">Aes</span><span class="pun">.</span><span class="pln">sBox</span><span class="pun">[</span><span class="pln">w</span><span class="pun">[</span><span class="pln">i</span><span class="pun">]];</span><span class="pln">
  </span><span class="kwd">return</span><span class="pln"> w</span><span class="pun">;</span><span class="pln">
</span><span class="pun">}</span><span class="pln">

</span><span class="typ">Aes</span><span class="pun">.</span><span class="pln">rotWord </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">(</span><span class="pln">w</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">    </span><span class="com">// rotate 4-byte word w left by one byte</span><span class="pln">
  </span><span class="kwd">var</span><span class="pln"> tmp </span><span class="pun">=</span><span class="pln"> w</span><span class="pun">[</span><span class="lit">0</span><span class="pun">];</span><span class="pln">
  </span><span class="kwd">for</span><span class="pln"> </span><span class="pun">(</span><span class="kwd">var</span><span class="pln"> i</span><span class="pun">=</span><span class="lit">0</span><span class="pun">;</span><span class="pln"> i</span><span class="pun">&lt;</span><span class="lit">3</span><span class="pun">;</span><span class="pln"> i</span><span class="pun">++)</span><span class="pln"> w</span><span class="pun">[</span><span class="pln">i</span><span class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> w</span><span class="pun">[</span><span class="pln">i</span><span class="pun">+</span><span class="lit">1</span><span class="pun">];</span><span class="pln">
  w</span><span class="pun">[</span><span class="lit">3</span><span class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> tmp</span><span class="pun">;</span><span class="pln">
  </span><span class="kwd">return</span><span class="pln"> w</span><span class="pun">;</span><span class="pln">
</span><span class="pun">}</span><span class="pln">

</span><span class="com">// sBox is pre-computed multiplicative inverse in GF(2^8) used in subBytes and keyExpansion [§5.1.1]</span><span class="pln">
</span><span class="typ">Aes</span><span class="pun">.</span><span class="pln">sBox </span><span class="pun">=</span><span class="pln">  </span><span class="pun">[</span><span class="lit">0x63</span><span class="pun">,</span><span class="lit">0x7c</span><span class="pun">,</span><span class="lit">0x77</span><span class="pun">,</span><span class="lit">0x7b</span><span class="pun">,</span><span class="lit">0xf2</span><span class="pun">,</span><span class="lit">0x6b</span><span class="pun">,</span><span class="lit">0x6f</span><span class="pun">,</span><span class="lit">0xc5</span><span class="pun">,</span><span class="lit">0x30</span><span class="pun">,</span><span class="lit">0x01</span><span class="pun">,</span><span class="lit">0x67</span><span class="pun">,</span><span class="lit">0x2b</span><span class="pun">,</span><span class="lit">0xfe</span><span class="pun">,</span><span class="lit">0xd7</span><span class="pun">,</span><span class="lit">0xab</span><span class="pun">,</span><span class="lit">0x76</span><span class="pun">,</span><span class="pln">
             </span><span class="lit">0xca</span><span class="pun">,</span><span class="lit">0x82</span><span class="pun">,</span><span class="lit">0xc9</span><span class="pun">,</span><span class="lit">0x7d</span><span class="pun">,</span><span class="lit">0xfa</span><span class="pun">,</span><span class="lit">0x59</span><span class="pun">,</span><span class="lit">0x47</span><span class="pun">,</span><span class="lit">0xf0</span><span class="pun">,</span><span class="lit">0xad</span><span class="pun">,</span><span class="lit">0xd4</span><span class="pun">,</span><span class="lit">0xa2</span><span class="pun">,</span><span class="lit">0xaf</span><span class="pun">,</span><span class="lit">0x9c</span><span class="pun">,</span><span class="lit">0xa4</span><span class="pun">,</span><span class="lit">0x72</span><span class="pun">,</span><span class="lit">0xc0</span><span class="pun">,</span><span class="pln">
             </span><span class="lit">0xb7</span><span class="pun">,</span><span class="lit">0xfd</span><span class="pun">,</span><span class="lit">0x93</span><span class="pun">,</span><span class="lit">0x26</span><span class="pun">,</span><span class="lit">0x36</span><span class="pun">,</span><span class="lit">0x3f</span><span class="pun">,</span><span class="lit">0xf7</span><span class="pun">,</span><span class="lit">0xcc</span><span class="pun">,</span><span class="lit">0x34</span><span class="pun">,</span><span class="lit">0xa5</span><span class="pun">,</span><span class="lit">0xe5</span><span class="pun">,</span><span class="lit">0xf1</span><span class="pun">,</span><span class="lit">0x71</span><span class="pun">,</span><span class="lit">0xd8</span><span class="pun">,</span><span class="lit">0x31</span><span class="pun">,</span><span class="lit">0x15</span><span class="pun">,</span><span class="pln">
             </span><span class="lit">0x04</span><span class="pun">,</span><span class="lit">0xc7</span><span class="pun">,</span><span class="lit">0x23</span><span class="pun">,</span><span class="lit">0xc3</span><span class="pun">,</span><span class="lit">0x18</span><span class="pun">,</span><span class="lit">0x96</span><span class="pun">,</span><span class="lit">0x05</span><span class="pun">,</span><span class="lit">0x9a</span><span class="pun">,</span><span class="lit">0x07</span><span class="pun">,</span><span class="lit">0x12</span><span class="pun">,</span><span class="lit">0x80</span><span class="pun">,</span><span class="lit">0xe2</span><span class="pun">,</span><span class="lit">0xeb</span><span class="pun">,</span><span class="lit">0x27</span><span class="pun">,</span><span class="lit">0xb2</span><span class="pun">,</span><span class="lit">0x75</span><span class="pun">,</span><span class="pln">
             </span><span class="lit">0x09</span><span class="pun">,</span><span class="lit">0x83</span><span class="pun">,</span><span class="lit">0x2c</span><span class="pun">,</span><span class="lit">0x1a</span><span class="pun">,</span><span class="lit">0x1b</span><span class="pun">,</span><span class="lit">0x6e</span><span class="pun">,</span><span class="lit">0x5a</span><span class="pun">,</span><span class="lit">0xa0</span><span class="pun">,</span><span class="lit">0x52</span><span class="pun">,</span><span class="lit">0x3b</span><span class="pun">,</span><span class="lit">0xd6</span><span class="pun">,</span><span class="lit">0xb3</span><span class="pun">,</span><span class="lit">0x29</span><span class="pun">,</span><span class="lit">0xe3</span><span class="pun">,</span><span class="lit">0x2f</span><span class="pun">,</span><span class="lit">0x84</span><span class="pun">,</span><span class="pln">
             </span><span class="lit">0x53</span><span class="pun">,</span><span class="lit">0xd1</span><span class="pun">,</span><span class="lit">0x00</span><span class="pun">,</span><span class="lit">0xed</span><span class="pun">,</span><span class="lit">0x20</span><span class="pun">,</span><span class="lit">0xfc</span><span class="pun">,</span><span class="lit">0xb1</span><span class="pun">,</span><span class="lit">0x5b</span><span class="pun">,</span><span class="lit">0x6a</span><span class="pun">,</span><span class="lit">0xcb</span><span class="pun">,</span><span class="lit">0xbe</span><span class="pun">,</span><span class="lit">0x39</span><span class="pun">,</span><span class="lit">0x4a</span><span class="pun">,</span><span class="lit">0x4c</span><span class="pun">,</span><span class="lit">0x58</span><span class="pun">,</span><span class="lit">0xcf</span><span class="pun">,</span><span class="pln">
             </span><span class="lit">0xd0</span><span class="pun">,</span><span class="lit">0xef</span><span class="pun">,</span><span class="lit">0xaa</span><span class="pun">,</span><span class="lit">0xfb</span><span class="pun">,</span><span class="lit">0x43</span><span class="pun">,</span><span class="lit">0x4d</span><span class="pun">,</span><span class="lit">0x33</span><span class="pun">,</span><span class="lit">0x85</span><span class="pun">,</span><span class="lit">0x45</span><span class="pun">,</span><span class="lit">0xf9</span><span class="pun">,</span><span class="lit">0x02</span><span class="pun">,</span><span class="lit">0x7f</span><span class="pun">,</span><span class="lit">0x50</span><span class="pun">,</span><span class="lit">0x3c</span><span class="pun">,</span><span class="lit">0x9f</span><span class="pun">,</span><span class="lit">0xa8</span><span class="pun">,</span><span class="pln">
             </span><span class="lit">0x51</span><span class="pun">,</span><span class="lit">0xa3</span><span class="pun">,</span><span class="lit">0x40</span><span class="pun">,</span><span class="lit">0x8f</span><span class="pun">,</span><span class="lit">0x92</span><span class="pun">,</span><span class="lit">0x9d</span><span class="pun">,</span><span class="lit">0x38</span><span class="pun">,</span><span class="lit">0xf5</span><span class="pun">,</span><span class="lit">0xbc</span><span class="pun">,</span><span class="lit">0xb6</span><span class="pun">,</span><span class="lit">0xda</span><span class="pun">,</span><span class="lit">0x21</span><span class="pun">,</span><span class="lit">0x10</span><span class="pun">,</span><span class="lit">0xff</span><span class="pun">,</span><span class="lit">0xf3</span><span class="pun">,</span><span class="lit">0xd2</span><span class="pun">,</span><span class="pln">
             </span><span class="lit">0xcd</span><span class="pun">,</span><span class="lit">0x0c</span><span class="pun">,</span><span class="lit">0x13</span><span class="pun">,</span><span class="lit">0xec</span><span class="pun">,</span><span class="lit">0x5f</span><span class="pun">,</span><span class="lit">0x97</span><span class="pun">,</span><span class="lit">0x44</span><span class="pun">,</span><span class="lit">0x17</span><span class="pun">,</span><span class="lit">0xc4</span><span class="pun">,</span><span class="lit">0xa7</span><span class="pun">,</span><span class="lit">0x7e</span><span class="pun">,</span><span class="lit">0x3d</span><span class="pun">,</span><span class="lit">0x64</span><span class="pun">,</span><span class="lit">0x5d</span><span class="pun">,</span><span class="lit">0x19</span><span class="pun">,</span><span class="lit">0x73</span><span class="pun">,</span><span class="pln">
             </span><span class="lit">0x60</span><span class="pun">,</span><span class="lit">0x81</span><span class="pun">,</span><span class="lit">0x4f</span><span class="pun">,</span><span class="lit">0xdc</span><span class="pun">,</span><span class="lit">0x22</span><span class="pun">,</span><span class="lit">0x2a</span><span class="pun">,</span><span class="lit">0x90</span><span class="pun">,</span><span class="lit">0x88</span><span class="pun">,</span><span class="lit">0x46</span><span class="pun">,</span><span class="lit">0xee</span><span class="pun">,</span><span class="lit">0xb8</span><span class="pun">,</span><span class="lit">0x14</span><span class="pun">,</span><span class="lit">0xde</span><span class="pun">,</span><span class="lit">0x5e</span><span class="pun">,</span><span class="lit">0x0b</span><span class="pun">,</span><span class="lit">0xdb</span><span class="pun">,</span><span class="pln">
             </span><span class="lit">0xe0</span><span class="pun">,</span><span class="lit">0x32</span><span class="pun">,</span><span class="lit">0x3a</span><span class="pun">,</span><span class="lit">0x0a</span><span class="pun">,</span><span class="lit">0x49</span><span class="pun">,</span><span class="lit">0x06</span><span class="pun">,</span><span class="lit">0x24</span><span class="pun">,</span><span class="lit">0x5c</span><span class="pun">,</span><span class="lit">0xc2</span><span class="pun">,</span><span class="lit">0xd3</span><span class="pun">,</span><span class="lit">0xac</span><span class="pun">,</span><span class="lit">0x62</span><span class="pun">,</span><span class="lit">0x91</span><span class="pun">,</span><span class="lit">0x95</span><span class="pun">,</span><span class="lit">0xe4</span><span class="pun">,</span><span class="lit">0x79</span><span class="pun">,</span><span class="pln">
             </span><span class="lit">0xe7</span><span class="pun">,</span><span class="lit">0xc8</span><span class="pun">,</span><span class="lit">0x37</span><span class="pun">,</span><span class="lit">0x6d</span><span class="pun">,</span><span class="lit">0x8d</span><span class="pun">,</span><span class="lit">0xd5</span><span class="pun">,</span><span class="lit">0x4e</span><span class="pun">,</span><span class="lit">0xa9</span><span class="pun">,</span><span class="lit">0x6c</span><span class="pun">,</span><span class="lit">0x56</span><span class="pun">,</span><span class="lit">0xf4</span><span class="pun">,</span><span class="lit">0xea</span><span class="pun">,</span><span class="lit">0x65</span><span class="pun">,</span><span class="lit">0x7a</span><span class="pun">,</span><span class="lit">0xae</span><span class="pun">,</span><span class="lit">0x08</span><span class="pun">,</span><span class="pln">
             </span><span class="lit">0xba</span><span class="pun">,</span><span class="lit">0x78</span><span class="pun">,</span><span class="lit">0x25</span><span class="pun">,</span><span class="lit">0x2e</span><span class="pun">,</span><span class="lit">0x1c</span><span class="pun">,</span><span class="lit">0xa6</span><span class="pun">,</span><span class="lit">0xb4</span><span class="pun">,</span><span class="lit">0xc6</span><span class="pun">,</span><span class="lit">0xe8</span><span class="pun">,</span><span class="lit">0xdd</span><span class="pun">,</span><span class="lit">0x74</span><span class="pun">,</span><span class="lit">0x1f</span><span class="pun">,</span><span class="lit">0x4b</span><span class="pun">,</span><span class="lit">0xbd</span><span class="pun">,</span><span class="lit">0x8b</span><span class="pun">,</span><span class="lit">0x8a</span><span class="pun">,</span><span class="pln">
             </span><span class="lit">0x70</span><span class="pun">,</span><span class="lit">0x3e</span><span class="pun">,</span><span class="lit">0xb5</span><span class="pun">,</span><span class="lit">0x66</span><span class="pun">,</span><span class="lit">0x48</span><span class="pun">,</span><span class="lit">0x03</span><span class="pun">,</span><span class="lit">0xf6</span><span class="pun">,</span><span class="lit">0x0e</span><span class="pun">,</span><span class="lit">0x61</span><span class="pun">,</span><span class="lit">0x35</span><span class="pun">,</span><span class="lit">0x57</span><span class="pun">,</span><span class="lit">0xb9</span><span class="pun">,</span><span class="lit">0x86</span><span class="pun">,</span><span class="lit">0xc1</span><span class="pun">,</span><span class="lit">0x1d</span><span class="pun">,</span><span class="lit">0x9e</span><span class="pun">,</span><span class="pln">
             </span><span class="lit">0xe1</span><span class="pun">,</span><span class="lit">0xf8</span><span class="pun">,</span><span class="lit">0x98</span><span class="pun">,</span><span class="lit">0x11</span><span class="pun">,</span><span class="lit">0x69</span><span class="pun">,</span><span class="lit">0xd9</span><span class="pun">,</span><span class="lit">0x8e</span><span class="pun">,</span><span class="lit">0x94</span><span class="pun">,</span><span class="lit">0x9b</span><span class="pun">,</span><span class="lit">0x1e</span><span class="pun">,</span><span class="lit">0x87</span><span class="pun">,</span><span class="lit">0xe9</span><span class="pun">,</span><span class="lit">0xce</span><span class="pun">,</span><span class="lit">0x55</span><span class="pun">,</span><span class="lit">0x28</span><span class="pun">,</span><span class="lit">0xdf</span><span class="pun">,</span><span class="pln">
             </span><span class="lit">0x8c</span><span class="pun">,</span><span class="lit">0xa1</span><span class="pun">,</span><span class="lit">0x89</span><span class="pun">,</span><span class="lit">0x0d</span><span class="pun">,</span><span class="lit">0xbf</span><span class="pun">,</span><span class="lit">0xe6</span><span class="pun">,</span><span class="lit">0x42</span><span class="pun">,</span><span class="lit">0x68</span><span class="pun">,</span><span class="lit">0x41</span><span class="pun">,</span><span class="lit">0x99</span><span class="pun">,</span><span class="lit">0x2d</span><span class="pun">,</span><span class="lit">0x0f</span><span class="pun">,</span><span class="lit">0xb0</span><span class="pun">,</span><span class="lit">0x54</span><span class="pun">,</span><span class="lit">0xbb</span><span class="pun">,</span><span class="lit">0x16</span><span class="pun">];</span><span class="pln">

</span><span class="com">// rCon is Round Constant used for the Key Expansion [1st col is 2^(r-1) in GF(2^8)] [§5.2]</span><span class="pln">
</span><span class="typ">Aes</span><span class="pun">.</span><span class="pln">rCon </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[</span><span class="pln"> </span><span class="pun">[</span><span class="lit">0x00</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0x00</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0x00</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0x00</span><span class="pun">],</span><span class="pln">
             </span><span class="pun">[</span><span class="lit">0x01</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0x00</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0x00</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0x00</span><span class="pun">],</span><span class="pln">
             </span><span class="pun">[</span><span class="lit">0x02</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0x00</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0x00</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0x00</span><span class="pun">],</span><span class="pln">
             </span><span class="pun">[</span><span class="lit">0x04</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0x00</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0x00</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0x00</span><span class="pun">],</span><span class="pln">
             </span><span class="pun">[</span><span class="lit">0x08</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0x00</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0x00</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0x00</span><span class="pun">],</span><span class="pln">
             </span><span class="pun">[</span><span class="lit">0x10</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0x00</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0x00</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0x00</span><span class="pun">],</span><span class="pln">
             </span><span class="pun">[</span><span class="lit">0x20</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0x00</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0x00</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0x00</span><span class="pun">],</span><span class="pln">
             </span><span class="pun">[</span><span class="lit">0x40</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0x00</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0x00</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0x00</span><span class="pun">],</span><span class="pln">
             </span><span class="pun">[</span><span class="lit">0x80</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0x00</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0x00</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0x00</span><span class="pun">],</span><span class="pln">
             </span><span class="pun">[</span><span class="lit">0x1b</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0x00</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0x00</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0x00</span><span class="pun">],</span><span class="pln">
             </span><span class="pun">[</span><span class="lit">0x36</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0x00</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0x00</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0x00</span><span class="pun">]</span><span class="pln"> </span><span class="pun">];</span><span class="pln"> 


</span><span class="com">/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -  */</span><span class="pln">
</span><span class="com">/*  AES Counter-mode implementation in JavaScript (c) Chris Veness 2005-2012                      */</span><span class="pln">
</span><span class="com">/*   - see http://csrc.nist.gov/publications/nistpubs/800-38a/sp800-38a.pdf                       */</span><span class="pln">
</span><span class="com">/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -  */</span><span class="pln">

</span><span class="typ">Aes</span><span class="pun">.</span><span class="typ">Ctr</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="pun">{};</span><span class="pln">  </span><span class="com">// Aes.Ctr namespace: a subclass or extension of Aes</span><span class="pln">

</span><span class="com">/** 
 * Encrypt a text using AES encryption in Counter mode of operation
 *
 * Unicode multi-byte character safe
 *
 * @param {String} plaintext Source text to be encrypted
 * @param {String} password  The password to use to generate a key
 * @param {Number} nBits     Number of bits to be used in the key (128, 192, or 256)
 * @returns {string}         Encrypted text
 */</span><span class="pln">
</span><span class="typ">Aes</span><span class="pun">.</span><span class="typ">Ctr</span><span class="pun">.</span><span class="pln">encrypt </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">(</span><span class="pln">plaintext</span><span class="pun">,</span><span class="pln"> password</span><span class="pun">,</span><span class="pln"> nBits</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
  </span><span class="kwd">var</span><span class="pln"> blockSize </span><span class="pun">=</span><span class="pln"> </span><span class="lit">16</span><span class="pun">;</span><span class="pln">  </span><span class="com">// block size fixed at 16 bytes / 128 bits (Nb=4) for AES</span><span class="pln">
  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(!(</span><span class="pln">nBits</span><span class="pun">==</span><span class="lit">128</span><span class="pln"> </span><span class="pun">||</span><span class="pln"> nBits</span><span class="pun">==</span><span class="lit">192</span><span class="pln"> </span><span class="pun">||</span><span class="pln"> nBits</span><span class="pun">==</span><span class="lit">256</span><span class="pun">))</span><span class="pln"> </span><span class="kwd">return</span><span class="pln"> </span><span class="str">''</span><span class="pun">;</span><span class="pln">  </span><span class="com">// standard allows 128/192/256 bit keys</span><span class="pln">
  plaintext </span><span class="pun">=</span><span class="pln"> </span><span class="typ">Utf8</span><span class="pun">.</span><span class="pln">encode</span><span class="pun">(</span><span class="pln">plaintext</span><span class="pun">);</span><span class="pln">
  password </span><span class="pun">=</span><span class="pln"> </span><span class="typ">Utf8</span><span class="pun">.</span><span class="pln">encode</span><span class="pun">(</span><span class="pln">password</span><span class="pun">);</span><span class="pln">
  </span><span class="com">//var t = new Date();  // timer</span><span class="pln">
	
  </span><span class="com">// use AES itself to encrypt password to get cipher key (using plain password as source for key </span><span class="pln">
  </span><span class="com">// expansion) - gives us well encrypted key (though hashed key might be preferred for prod'n use)</span><span class="pln">
  </span><span class="kwd">var</span><span class="pln"> nBytes </span><span class="pun">=</span><span class="pln"> nBits</span><span class="pun">/</span><span class="lit">8</span><span class="pun">;</span><span class="pln">  </span><span class="com">// no bytes in key (16/24/32)</span><span class="pln">
  </span><span class="kwd">var</span><span class="pln"> pwBytes </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">Array</span><span class="pun">(</span><span class="pln">nBytes</span><span class="pun">);</span><span class="pln">
  </span><span class="kwd">for</span><span class="pln"> </span><span class="pun">(</span><span class="kwd">var</span><span class="pln"> i</span><span class="pun">=</span><span class="lit">0</span><span class="pun">;</span><span class="pln"> i</span><span class="pun">&lt;</span><span class="pln">nBytes</span><span class="pun">;</span><span class="pln"> i</span><span class="pun">++)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">  </span><span class="com">// use 1st 16/24/32 chars of password for key</span><span class="pln">
    pwBytes</span><span class="pun">[</span><span class="pln">i</span><span class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> isNaN</span><span class="pun">(</span><span class="pln">password</span><span class="pun">.</span><span class="pln">charCodeAt</span><span class="pun">(</span><span class="pln">i</span><span class="pun">))</span><span class="pln"> </span><span class="pun">?</span><span class="pln"> </span><span class="lit">0</span><span class="pln"> </span><span class="pun">:</span><span class="pln"> password</span><span class="pun">.</span><span class="pln">charCodeAt</span><span class="pun">(</span><span class="pln">i</span><span class="pun">);</span><span class="pln">
  </span><span class="pun">}</span><span class="pln">
  </span><span class="kwd">var</span><span class="pln"> key </span><span class="pun">=</span><span class="pln"> </span><span class="typ">Aes</span><span class="pun">.</span><span class="pln">cipher</span><span class="pun">(</span><span class="pln">pwBytes</span><span class="pun">,</span><span class="pln"> </span><span class="typ">Aes</span><span class="pun">.</span><span class="pln">keyExpansion</span><span class="pun">(</span><span class="pln">pwBytes</span><span class="pun">));</span><span class="pln">  </span><span class="com">// gives us 16-byte key</span><span class="pln">
  key </span><span class="pun">=</span><span class="pln"> key</span><span class="pun">.</span><span class="pln">concat</span><span class="pun">(</span><span class="pln">key</span><span class="pun">.</span><span class="pln">slice</span><span class="pun">(</span><span class="lit">0</span><span class="pun">,</span><span class="pln"> nBytes</span><span class="pun">-</span><span class="lit">16</span><span class="pun">));</span><span class="pln">  </span><span class="com">// expand key to 16/24/32 bytes long</span><span class="pln">

  </span><span class="com">// initialise 1st 8 bytes of counter block with nonce (NIST SP800-38A §B.2): [0-1] = millisec, </span><span class="pln">
  </span><span class="com">// [2-3] = random, [4-7] = seconds, together giving full sub-millisec uniqueness up to Feb 2106</span><span class="pln">
  </span><span class="kwd">var</span><span class="pln"> counterBlock </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">Array</span><span class="pun">(</span><span class="pln">blockSize</span><span class="pun">);</span><span class="pln">
  
  </span><span class="kwd">var</span><span class="pln"> nonce </span><span class="pun">=</span><span class="pln"> </span><span class="pun">(</span><span class="kwd">new</span><span class="pln"> </span><span class="typ">Date</span><span class="pun">()).</span><span class="pln">getTime</span><span class="pun">();</span><span class="pln">  </span><span class="com">// timestamp: milliseconds since 1-Jan-1970</span><span class="pln">
  </span><span class="kwd">var</span><span class="pln"> nonceMs </span><span class="pun">=</span><span class="pln"> nonce</span><span class="pun">%</span><span class="lit">1000</span><span class="pun">;</span><span class="pln">
  </span><span class="kwd">var</span><span class="pln"> nonceSec </span><span class="pun">=</span><span class="pln"> </span><span class="typ">Math</span><span class="pun">.</span><span class="pln">floor</span><span class="pun">(</span><span class="pln">nonce</span><span class="pun">/</span><span class="lit">1000</span><span class="pun">);</span><span class="pln">
  </span><span class="kwd">var</span><span class="pln"> nonceRnd </span><span class="pun">=</span><span class="pln"> </span><span class="typ">Math</span><span class="pun">.</span><span class="pln">floor</span><span class="pun">(</span><span class="typ">Math</span><span class="pun">.</span><span class="pln">random</span><span class="pun">()*</span><span class="lit">0xffff</span><span class="pun">);</span><span class="pln">
  
  </span><span class="kwd">for</span><span class="pln"> </span><span class="pun">(</span><span class="kwd">var</span><span class="pln"> i</span><span class="pun">=</span><span class="lit">0</span><span class="pun">;</span><span class="pln"> i</span><span class="pun">&lt;</span><span class="lit">2</span><span class="pun">;</span><span class="pln"> i</span><span class="pun">++)</span><span class="pln"> counterBlock</span><span class="pun">[</span><span class="pln">i</span><span class="pun">]</span><span class="pln">   </span><span class="pun">=</span><span class="pln"> </span><span class="pun">(</span><span class="pln">nonceMs  </span><span class="pun">&gt;&gt;&gt;</span><span class="pln"> i</span><span class="pun">*</span><span class="lit">8</span><span class="pun">)</span><span class="pln"> </span><span class="pun">&amp;</span><span class="pln"> </span><span class="lit">0xff</span><span class="pun">;</span><span class="pln">
  </span><span class="kwd">for</span><span class="pln"> </span><span class="pun">(</span><span class="kwd">var</span><span class="pln"> i</span><span class="pun">=</span><span class="lit">0</span><span class="pun">;</span><span class="pln"> i</span><span class="pun">&lt;</span><span class="lit">2</span><span class="pun">;</span><span class="pln"> i</span><span class="pun">++)</span><span class="pln"> counterBlock</span><span class="pun">[</span><span class="pln">i</span><span class="pun">+</span><span class="lit">2</span><span class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="pun">(</span><span class="pln">nonceRnd </span><span class="pun">&gt;&gt;&gt;</span><span class="pln"> i</span><span class="pun">*</span><span class="lit">8</span><span class="pun">)</span><span class="pln"> </span><span class="pun">&amp;</span><span class="pln"> </span><span class="lit">0xff</span><span class="pun">;</span><span class="pln">
  </span><span class="kwd">for</span><span class="pln"> </span><span class="pun">(</span><span class="kwd">var</span><span class="pln"> i</span><span class="pun">=</span><span class="lit">0</span><span class="pun">;</span><span class="pln"> i</span><span class="pun">&lt;</span><span class="lit">4</span><span class="pun">;</span><span class="pln"> i</span><span class="pun">++)</span><span class="pln"> counterBlock</span><span class="pun">[</span><span class="pln">i</span><span class="pun">+</span><span class="lit">4</span><span class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="pun">(</span><span class="pln">nonceSec </span><span class="pun">&gt;&gt;&gt;</span><span class="pln"> i</span><span class="pun">*</span><span class="lit">8</span><span class="pun">)</span><span class="pln"> </span><span class="pun">&amp;</span><span class="pln"> </span><span class="lit">0xff</span><span class="pun">;</span><span class="pln">
  
  </span><span class="com">// and convert it to a string to go on the front of the ciphertext</span><span class="pln">
  </span><span class="kwd">var</span><span class="pln"> ctrTxt </span><span class="pun">=</span><span class="pln"> </span><span class="str">''</span><span class="pun">;</span><span class="pln">
  </span><span class="kwd">for</span><span class="pln"> </span><span class="pun">(</span><span class="kwd">var</span><span class="pln"> i</span><span class="pun">=</span><span class="lit">0</span><span class="pun">;</span><span class="pln"> i</span><span class="pun">&lt;</span><span class="lit">8</span><span class="pun">;</span><span class="pln"> i</span><span class="pun">++)</span><span class="pln"> ctrTxt </span><span class="pun">+=</span><span class="pln"> </span><span class="typ">String</span><span class="pun">.</span><span class="pln">fromCharCode</span><span class="pun">(</span><span class="pln">counterBlock</span><span class="pun">[</span><span class="pln">i</span><span class="pun">]);</span><span class="pln">

  </span><span class="com">// generate key schedule - an expansion of the key into distinct Key Rounds for each round</span><span class="pln">
  </span><span class="kwd">var</span><span class="pln"> keySchedule </span><span class="pun">=</span><span class="pln"> </span><span class="typ">Aes</span><span class="pun">.</span><span class="pln">keyExpansion</span><span class="pun">(</span><span class="pln">key</span><span class="pun">);</span><span class="pln">
  
  </span><span class="kwd">var</span><span class="pln"> blockCount </span><span class="pun">=</span><span class="pln"> </span><span class="typ">Math</span><span class="pun">.</span><span class="pln">ceil</span><span class="pun">(</span><span class="pln">plaintext</span><span class="pun">.</span><span class="pln">length</span><span class="pun">/</span><span class="pln">blockSize</span><span class="pun">);</span><span class="pln">
  </span><span class="kwd">var</span><span class="pln"> ciphertxt </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">Array</span><span class="pun">(</span><span class="pln">blockCount</span><span class="pun">);</span><span class="pln">  </span><span class="com">// ciphertext as array of strings</span><span class="pln">
  
  </span><span class="kwd">for</span><span class="pln"> </span><span class="pun">(</span><span class="kwd">var</span><span class="pln"> b</span><span class="pun">=</span><span class="lit">0</span><span class="pun">;</span><span class="pln"> b</span><span class="pun">&lt;</span><span class="pln">blockCount</span><span class="pun">;</span><span class="pln"> b</span><span class="pun">++)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
    </span><span class="com">// set counter (block #) in last 8 bytes of counter block (leaving nonce in 1st 8 bytes)</span><span class="pln">
    </span><span class="com">// done in two stages for 32-bit ops: using two words allows us to go past 2^32 blocks (68GB)</span><span class="pln">
    </span><span class="kwd">for</span><span class="pln"> </span><span class="pun">(</span><span class="kwd">var</span><span class="pln"> c</span><span class="pun">=</span><span class="lit">0</span><span class="pun">;</span><span class="pln"> c</span><span class="pun">&lt;</span><span class="lit">4</span><span class="pun">;</span><span class="pln"> c</span><span class="pun">++)</span><span class="pln"> counterBlock</span><span class="pun">[</span><span class="lit">15</span><span class="pun">-</span><span class="pln">c</span><span class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="pun">(</span><span class="pln">b </span><span class="pun">&gt;&gt;&gt;</span><span class="pln"> c</span><span class="pun">*</span><span class="lit">8</span><span class="pun">)</span><span class="pln"> </span><span class="pun">&amp;</span><span class="pln"> </span><span class="lit">0xff</span><span class="pun">;</span><span class="pln">
    </span><span class="kwd">for</span><span class="pln"> </span><span class="pun">(</span><span class="kwd">var</span><span class="pln"> c</span><span class="pun">=</span><span class="lit">0</span><span class="pun">;</span><span class="pln"> c</span><span class="pun">&lt;</span><span class="lit">4</span><span class="pun">;</span><span class="pln"> c</span><span class="pun">++)</span><span class="pln"> counterBlock</span><span class="pun">[</span><span class="lit">15</span><span class="pun">-</span><span class="pln">c</span><span class="pun">-</span><span class="lit">4</span><span class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="pun">(</span><span class="pln">b</span><span class="pun">/</span><span class="lit">0x100000000</span><span class="pln"> </span><span class="pun">&gt;&gt;&gt;</span><span class="pln"> c</span><span class="pun">*</span><span class="lit">8</span><span class="pun">)</span><span class="pln">

    </span><span class="kwd">var</span><span class="pln"> cipherCntr </span><span class="pun">=</span><span class="pln"> </span><span class="typ">Aes</span><span class="pun">.</span><span class="pln">cipher</span><span class="pun">(</span><span class="pln">counterBlock</span><span class="pun">,</span><span class="pln"> keySchedule</span><span class="pun">);</span><span class="pln">  </span><span class="com">// -- encrypt counter block --</span><span class="pln">
    
    </span><span class="com">// block size is reduced on final block</span><span class="pln">
    </span><span class="kwd">var</span><span class="pln"> blockLength </span><span class="pun">=</span><span class="pln"> b</span><span class="pun">&lt;</span><span class="pln">blockCount</span><span class="pun">-</span><span class="lit">1</span><span class="pln"> </span><span class="pun">?</span><span class="pln"> blockSize </span><span class="pun">:</span><span class="pln"> </span><span class="pun">(</span><span class="pln">plaintext</span><span class="pun">.</span><span class="pln">length</span><span class="pun">-</span><span class="lit">1</span><span class="pun">)%</span><span class="pln">blockSize</span><span class="pun">+</span><span class="lit">1</span><span class="pun">;</span><span class="pln">
    </span><span class="kwd">var</span><span class="pln"> cipherChar </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">Array</span><span class="pun">(</span><span class="pln">blockLength</span><span class="pun">);</span><span class="pln">
    
    </span><span class="kwd">for</span><span class="pln"> </span><span class="pun">(</span><span class="kwd">var</span><span class="pln"> i</span><span class="pun">=</span><span class="lit">0</span><span class="pun">;</span><span class="pln"> i</span><span class="pun">&lt;</span><span class="pln">blockLength</span><span class="pun">;</span><span class="pln"> i</span><span class="pun">++)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">  </span><span class="com">// -- xor plaintext with ciphered counter char-by-char --</span><span class="pln">
      cipherChar</span><span class="pun">[</span><span class="pln">i</span><span class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> cipherCntr</span><span class="pun">[</span><span class="pln">i</span><span class="pun">]</span><span class="pln"> </span><span class="pun">^</span><span class="pln"> plaintext</span><span class="pun">.</span><span class="pln">charCodeAt</span><span class="pun">(</span><span class="pln">b</span><span class="pun">*</span><span class="pln">blockSize</span><span class="pun">+</span><span class="pln">i</span><span class="pun">);</span><span class="pln">
      cipherChar</span><span class="pun">[</span><span class="pln">i</span><span class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="typ">String</span><span class="pun">.</span><span class="pln">fromCharCode</span><span class="pun">(</span><span class="pln">cipherChar</span><span class="pun">[</span><span class="pln">i</span><span class="pun">]);</span><span class="pln">
    </span><span class="pun">}</span><span class="pln">
    ciphertxt</span><span class="pun">[</span><span class="pln">b</span><span class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> cipherChar</span><span class="pun">.</span><span class="pln">join</span><span class="pun">(</span><span class="str">''</span><span class="pun">);</span><span class="pln"> 
  </span><span class="pun">}</span><span class="pln">

  </span><span class="com">// Array.join is more efficient than repeated string concatenation in IE</span><span class="pln">
  </span><span class="kwd">var</span><span class="pln"> ciphertext </span><span class="pun">=</span><span class="pln"> ctrTxt </span><span class="pun">+</span><span class="pln"> ciphertxt</span><span class="pun">.</span><span class="pln">join</span><span class="pun">(</span><span class="str">''</span><span class="pun">);</span><span class="pln">
  ciphertext </span><span class="pun">=</span><span class="pln"> </span><span class="typ">Base64</span><span class="pun">.</span><span class="pln">encode</span><span class="pun">(</span><span class="pln">ciphertext</span><span class="pun">);</span><span class="pln">  </span><span class="com">// encode in base64</span><span class="pln">
  
  </span><span class="com">//alert((new Date()) - t);</span><span class="pln">
  </span><span class="kwd">return</span><span class="pln"> ciphertext</span><span class="pun">;</span><span class="pln">
</span><span class="pun">}</span><span class="pln">

</span><span class="com">/** 
 * Decrypt a text encrypted by AES in counter mode of operation
 *
 * @param {String} ciphertext Source text to be encrypted
 * @param {String} password   The password to use to generate a key
 * @param {Number} nBits      Number of bits to be used in the key (128, 192, or 256)
 * @returns {String}          Decrypted text
 */</span><span class="pln">
</span><span class="typ">Aes</span><span class="pun">.</span><span class="typ">Ctr</span><span class="pun">.</span><span class="pln">decrypt </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">(</span><span class="pln">ciphertext</span><span class="pun">,</span><span class="pln"> password</span><span class="pun">,</span><span class="pln"> nBits</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
  </span><span class="kwd">var</span><span class="pln"> blockSize </span><span class="pun">=</span><span class="pln"> </span><span class="lit">16</span><span class="pun">;</span><span class="pln">  </span><span class="com">// block size fixed at 16 bytes / 128 bits (Nb=4) for AES</span><span class="pln">
  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(!(</span><span class="pln">nBits</span><span class="pun">==</span><span class="lit">128</span><span class="pln"> </span><span class="pun">||</span><span class="pln"> nBits</span><span class="pun">==</span><span class="lit">192</span><span class="pln"> </span><span class="pun">||</span><span class="pln"> nBits</span><span class="pun">==</span><span class="lit">256</span><span class="pun">))</span><span class="pln"> </span><span class="kwd">return</span><span class="pln"> </span><span class="str">''</span><span class="pun">;</span><span class="pln">  </span><span class="com">// standard allows 128/192/256 bit keys</span><span class="pln">
  ciphertext </span><span class="pun">=</span><span class="pln"> </span><span class="typ">Base64</span><span class="pun">.</span><span class="pln">decode</span><span class="pun">(</span><span class="pln">ciphertext</span><span class="pun">);</span><span class="pln">
  password </span><span class="pun">=</span><span class="pln"> </span><span class="typ">Utf8</span><span class="pun">.</span><span class="pln">encode</span><span class="pun">(</span><span class="pln">password</span><span class="pun">);</span><span class="pln">
  </span><span class="com">//var t = new Date();  // timer</span><span class="pln">
  
  </span><span class="com">// use AES to encrypt password (mirroring encrypt routine)</span><span class="pln">
  </span><span class="kwd">var</span><span class="pln"> nBytes </span><span class="pun">=</span><span class="pln"> nBits</span><span class="pun">/</span><span class="lit">8</span><span class="pun">;</span><span class="pln">  </span><span class="com">// no bytes in key</span><span class="pln">
  </span><span class="kwd">var</span><span class="pln"> pwBytes </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">Array</span><span class="pun">(</span><span class="pln">nBytes</span><span class="pun">);</span><span class="pln">
  </span><span class="kwd">for</span><span class="pln"> </span><span class="pun">(</span><span class="kwd">var</span><span class="pln"> i</span><span class="pun">=</span><span class="lit">0</span><span class="pun">;</span><span class="pln"> i</span><span class="pun">&lt;</span><span class="pln">nBytes</span><span class="pun">;</span><span class="pln"> i</span><span class="pun">++)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
    pwBytes</span><span class="pun">[</span><span class="pln">i</span><span class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> isNaN</span><span class="pun">(</span><span class="pln">password</span><span class="pun">.</span><span class="pln">charCodeAt</span><span class="pun">(</span><span class="pln">i</span><span class="pun">))</span><span class="pln"> </span><span class="pun">?</span><span class="pln"> </span><span class="lit">0</span><span class="pln"> </span><span class="pun">:</span><span class="pln"> password</span><span class="pun">.</span><span class="pln">charCodeAt</span><span class="pun">(</span><span class="pln">i</span><span class="pun">);</span><span class="pln">
  </span><span class="pun">}</span><span class="pln">
  </span><span class="kwd">var</span><span class="pln"> key </span><span class="pun">=</span><span class="pln"> </span><span class="typ">Aes</span><span class="pun">.</span><span class="pln">cipher</span><span class="pun">(</span><span class="pln">pwBytes</span><span class="pun">,</span><span class="pln"> </span><span class="typ">Aes</span><span class="pun">.</span><span class="pln">keyExpansion</span><span class="pun">(</span><span class="pln">pwBytes</span><span class="pun">));</span><span class="pln">
  key </span><span class="pun">=</span><span class="pln"> key</span><span class="pun">.</span><span class="pln">concat</span><span class="pun">(</span><span class="pln">key</span><span class="pun">.</span><span class="pln">slice</span><span class="pun">(</span><span class="lit">0</span><span class="pun">,</span><span class="pln"> nBytes</span><span class="pun">-</span><span class="lit">16</span><span class="pun">));</span><span class="pln">  </span><span class="com">// expand key to 16/24/32 bytes long</span><span class="pln">

  </span><span class="com">// recover nonce from 1st 8 bytes of ciphertext</span><span class="pln">
  </span><span class="kwd">var</span><span class="pln"> counterBlock </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">Array</span><span class="pun">(</span><span class="lit">8</span><span class="pun">);</span><span class="pln">
  ctrTxt </span><span class="pun">=</span><span class="pln"> ciphertext</span><span class="pun">.</span><span class="pln">slice</span><span class="pun">(</span><span class="lit">0</span><span class="pun">,</span><span class="pln"> </span><span class="lit">8</span><span class="pun">);</span><span class="pln">
  </span><span class="kwd">for</span><span class="pln"> </span><span class="pun">(</span><span class="kwd">var</span><span class="pln"> i</span><span class="pun">=</span><span class="lit">0</span><span class="pun">;</span><span class="pln"> i</span><span class="pun">&lt;</span><span class="lit">8</span><span class="pun">;</span><span class="pln"> i</span><span class="pun">++)</span><span class="pln"> counterBlock</span><span class="pun">[</span><span class="pln">i</span><span class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> ctrTxt</span><span class="pun">.</span><span class="pln">charCodeAt</span><span class="pun">(</span><span class="pln">i</span><span class="pun">);</span><span class="pln">
  
  </span><span class="com">// generate key schedule</span><span class="pln">
  </span><span class="kwd">var</span><span class="pln"> keySchedule </span><span class="pun">=</span><span class="pln"> </span><span class="typ">Aes</span><span class="pun">.</span><span class="pln">keyExpansion</span><span class="pun">(</span><span class="pln">key</span><span class="pun">);</span><span class="pln">

  </span><span class="com">// separate ciphertext into blocks (skipping past initial 8 bytes)</span><span class="pln">
  </span><span class="kwd">var</span><span class="pln"> nBlocks </span><span class="pun">=</span><span class="pln"> </span><span class="typ">Math</span><span class="pun">.</span><span class="pln">ceil</span><span class="pun">((</span><span class="pln">ciphertext</span><span class="pun">.</span><span class="pln">length</span><span class="pun">-</span><span class="lit">8</span><span class="pun">)</span><span class="pln"> </span><span class="pun">/</span><span class="pln"> blockSize</span><span class="pun">);</span><span class="pln">
  </span><span class="kwd">var</span><span class="pln"> ct </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">Array</span><span class="pun">(</span><span class="pln">nBlocks</span><span class="pun">);</span><span class="pln">
  </span><span class="kwd">for</span><span class="pln"> </span><span class="pun">(</span><span class="kwd">var</span><span class="pln"> b</span><span class="pun">=</span><span class="lit">0</span><span class="pun">;</span><span class="pln"> b</span><span class="pun">&lt;</span><span class="pln">nBlocks</span><span class="pun">;</span><span class="pln"> b</span><span class="pun">++)</span><span class="pln"> ct</span><span class="pun">[</span><span class="pln">b</span><span class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> ciphertext</span><span class="pun">.</span><span class="pln">slice</span><span class="pun">(</span><span class="lit">8</span><span class="pun">+</span><span class="pln">b</span><span class="pun">*</span><span class="pln">blockSize</span><span class="pun">,</span><span class="pln"> </span><span class="lit">8</span><span class="pun">+</span><span class="pln">b</span><span class="pun">*</span><span class="pln">blockSize</span><span class="pun">+</span><span class="pln">blockSize</span><span class="pun">);</span><span class="pln">
  ciphertext </span><span class="pun">=</span><span class="pln"> ct</span><span class="pun">;</span><span class="pln">  </span><span class="com">// ciphertext is now array of block-length strings</span><span class="pln">

  </span><span class="com">// plaintext will get generated block-by-block into array of block-length strings</span><span class="pln">
  </span><span class="kwd">var</span><span class="pln"> plaintxt </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">Array</span><span class="pun">(</span><span class="pln">ciphertext</span><span class="pun">.</span><span class="pln">length</span><span class="pun">);</span><span class="pln">

  </span><span class="kwd">for</span><span class="pln"> </span><span class="pun">(</span><span class="kwd">var</span><span class="pln"> b</span><span class="pun">=</span><span class="lit">0</span><span class="pun">;</span><span class="pln"> b</span><span class="pun">&lt;</span><span class="pln">nBlocks</span><span class="pun">;</span><span class="pln"> b</span><span class="pun">++)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
    </span><span class="com">// set counter (block #) in last 8 bytes of counter block (leaving nonce in 1st 8 bytes)</span><span class="pln">
    </span><span class="kwd">for</span><span class="pln"> </span><span class="pun">(</span><span class="kwd">var</span><span class="pln"> c</span><span class="pun">=</span><span class="lit">0</span><span class="pun">;</span><span class="pln"> c</span><span class="pun">&lt;</span><span class="lit">4</span><span class="pun">;</span><span class="pln"> c</span><span class="pun">++)</span><span class="pln"> counterBlock</span><span class="pun">[</span><span class="lit">15</span><span class="pun">-</span><span class="pln">c</span><span class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="pun">((</span><span class="pln">b</span><span class="pun">)</span><span class="pln"> </span><span class="pun">&gt;&gt;&gt;</span><span class="pln"> c</span><span class="pun">*</span><span class="lit">8</span><span class="pun">)</span><span class="pln"> </span><span class="pun">&amp;</span><span class="pln"> </span><span class="lit">0xff</span><span class="pun">;</span><span class="pln">
    </span><span class="kwd">for</span><span class="pln"> </span><span class="pun">(</span><span class="kwd">var</span><span class="pln"> c</span><span class="pun">=</span><span class="lit">0</span><span class="pun">;</span><span class="pln"> c</span><span class="pun">&lt;</span><span class="lit">4</span><span class="pun">;</span><span class="pln"> c</span><span class="pun">++)</span><span class="pln"> counterBlock</span><span class="pun">[</span><span class="lit">15</span><span class="pun">-</span><span class="pln">c</span><span class="pun">-</span><span class="lit">4</span><span class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="pun">(((</span><span class="pln">b</span><span class="pun">+</span><span class="lit">1</span><span class="pun">)/</span><span class="lit">0x100000000</span><span class="pun">-</span><span class="lit">1</span><span class="pun">)</span><span class="pln"> </span><span class="pun">&gt;&gt;&gt;</span><span class="pln"> c</span><span class="pun">*</span><span class="lit">8</span><span class="pun">)</span><span class="pln"> </span><span class="pun">&amp;</span><span class="pln"> </span><span class="lit">0xff</span><span class="pun">;</span><span class="pln">

    </span><span class="kwd">var</span><span class="pln"> cipherCntr </span><span class="pun">=</span><span class="pln"> </span><span class="typ">Aes</span><span class="pun">.</span><span class="pln">cipher</span><span class="pun">(</span><span class="pln">counterBlock</span><span class="pun">,</span><span class="pln"> keySchedule</span><span class="pun">);</span><span class="pln">  </span><span class="com">// encrypt counter block</span><span class="pln">

    </span><span class="kwd">var</span><span class="pln"> plaintxtByte </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">Array</span><span class="pun">(</span><span class="pln">ciphertext</span><span class="pun">[</span><span class="pln">b</span><span class="pun">].</span><span class="pln">length</span><span class="pun">);</span><span class="pln">
    </span><span class="kwd">for</span><span class="pln"> </span><span class="pun">(</span><span class="kwd">var</span><span class="pln"> i</span><span class="pun">=</span><span class="lit">0</span><span class="pun">;</span><span class="pln"> i</span><span class="pun">&lt;</span><span class="pln">ciphertext</span><span class="pun">[</span><span class="pln">b</span><span class="pun">].</span><span class="pln">length</span><span class="pun">;</span><span class="pln"> i</span><span class="pun">++)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
      </span><span class="com">// -- xor plaintxt with ciphered counter byte-by-byte --</span><span class="pln">
      plaintxtByte</span><span class="pun">[</span><span class="pln">i</span><span class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> cipherCntr</span><span class="pun">[</span><span class="pln">i</span><span class="pun">]</span><span class="pln"> </span><span class="pun">^</span><span class="pln"> ciphertext</span><span class="pun">[</span><span class="pln">b</span><span class="pun">].</span><span class="pln">charCodeAt</span><span class="pun">(</span><span class="pln">i</span><span class="pun">);</span><span class="pln">
      plaintxtByte</span><span class="pun">[</span><span class="pln">i</span><span class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="typ">String</span><span class="pun">.</span><span class="pln">fromCharCode</span><span class="pun">(</span><span class="pln">plaintxtByte</span><span class="pun">[</span><span class="pln">i</span><span class="pun">]);</span><span class="pln">
    </span><span class="pun">}</span><span class="pln">
    plaintxt</span><span class="pun">[</span><span class="pln">b</span><span class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> plaintxtByte</span><span class="pun">.</span><span class="pln">join</span><span class="pun">(</span><span class="str">''</span><span class="pun">);</span><span class="pln">
  </span><span class="pun">}</span><span class="pln">

  </span><span class="com">// join array of blocks into single plaintext string</span><span class="pln">
  </span><span class="kwd">var</span><span class="pln"> plaintext </span><span class="pun">=</span><span class="pln"> plaintxt</span><span class="pun">.</span><span class="pln">join</span><span class="pun">(</span><span class="str">''</span><span class="pun">);</span><span class="pln">
  plaintext </span><span class="pun">=</span><span class="pln"> </span><span class="typ">Utf8</span><span class="pun">.</span><span class="pln">decode</span><span class="pun">(</span><span class="pln">plaintext</span><span class="pun">);</span><span class="pln">  </span><span class="com">// decode from UTF8 back to Unicode multi-byte chars</span><span class="pln">
  
  </span><span class="com">//alert((new Date()) - t);</span><span class="pln">
  </span><span class="kwd">return</span><span class="pln"> plaintext</span><span class="pun">;</span><span class="pln">
</span><span class="pun">}</span><span class="pln">


</span><span class="com">/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -  */</span><span class="pln">
</span><span class="com">/*  Base64 class: Base 64 encoding / decoding (c) Chris Veness 2002-2012                          */</span><span class="pln">
</span><span class="com">/*    note: depends on Utf8 class                                                                 */</span><span class="pln">
</span><span class="com">/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -  */</span><span class="pln">

</span><span class="kwd">var</span><span class="pln"> </span><span class="typ">Base64</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="pun">{};</span><span class="pln">  </span><span class="com">// Base64 namespace</span><span class="pln">

</span><span class="typ">Base64</span><span class="pun">.</span><span class="pln">code </span><span class="pun">=</span><span class="pln"> </span><span class="str">"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/="</span><span class="pun">;</span><span class="pln">

</span><span class="com">/**
 * Encode string into Base64, as defined by RFC 4648 [http://tools.ietf.org/html/rfc4648]
 * (instance method extending String object). As per RFC 4648, no newlines are added.
 *
 * @param {String} str The string to be encoded as base-64
 * @param {Boolean} [utf8encode=false] Flag to indicate whether str is Unicode string to be encoded 
 *   to UTF8 before conversion to base64; otherwise string is assumed to be 8-bit characters
 * @returns {String} Base64-encoded string
 */</span><span class="pln"> 
</span><span class="typ">Base64</span><span class="pun">.</span><span class="pln">encode </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">(</span><span class="pln">str</span><span class="pun">,</span><span class="pln"> utf8encode</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">  </span><span class="com">// http://tools.ietf.org/html/rfc4648</span><span class="pln">
  utf8encode </span><span class="pun">=</span><span class="pln">  </span><span class="pun">(</span><span class="kwd">typeof</span><span class="pln"> utf8encode </span><span class="pun">==</span><span class="pln"> </span><span class="str">'undefined'</span><span class="pun">)</span><span class="pln"> </span><span class="pun">?</span><span class="pln"> </span><span class="kwd">false</span><span class="pln"> </span><span class="pun">:</span><span class="pln"> utf8encode</span><span class="pun">;</span><span class="pln">
  </span><span class="kwd">var</span><span class="pln"> o1</span><span class="pun">,</span><span class="pln"> o2</span><span class="pun">,</span><span class="pln"> o3</span><span class="pun">,</span><span class="pln"> bits</span><span class="pun">,</span><span class="pln"> h1</span><span class="pun">,</span><span class="pln"> h2</span><span class="pun">,</span><span class="pln"> h3</span><span class="pun">,</span><span class="pln"> h4</span><span class="pun">,</span><span class="pln"> e</span><span class="pun">=[],</span><span class="pln"> pad </span><span class="pun">=</span><span class="pln"> </span><span class="str">''</span><span class="pun">,</span><span class="pln"> c</span><span class="pun">,</span><span class="pln"> plain</span><span class="pun">,</span><span class="pln"> coded</span><span class="pun">;</span><span class="pln">
  </span><span class="kwd">var</span><span class="pln"> b64 </span><span class="pun">=</span><span class="pln"> </span><span class="typ">Base64</span><span class="pun">.</span><span class="pln">code</span><span class="pun">;</span><span class="pln">
   
  plain </span><span class="pun">=</span><span class="pln"> utf8encode </span><span class="pun">?</span><span class="pln"> str</span><span class="pun">.</span><span class="pln">encodeUTF8</span><span class="pun">()</span><span class="pln"> </span><span class="pun">:</span><span class="pln"> str</span><span class="pun">;</span><span class="pln">
  
  c </span><span class="pun">=</span><span class="pln"> plain</span><span class="pun">.</span><span class="pln">length </span><span class="pun">%</span><span class="pln"> </span><span class="lit">3</span><span class="pun">;</span><span class="pln">  </span><span class="com">// pad string to length of multiple of 3</span><span class="pln">
  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">c </span><span class="pun">&gt;</span><span class="pln"> </span><span class="lit">0</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> </span><span class="kwd">while</span><span class="pln"> </span><span class="pun">(</span><span class="pln">c</span><span class="pun">++</span><span class="pln"> </span><span class="pun">&lt;</span><span class="pln"> </span><span class="lit">3</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> pad </span><span class="pun">+=</span><span class="pln"> </span><span class="str">'='</span><span class="pun">;</span><span class="pln"> plain </span><span class="pun">+=</span><span class="pln"> </span><span class="str">'\0'</span><span class="pun">;</span><span class="pln"> </span><span class="pun">}</span><span class="pln"> </span><span class="pun">}</span><span class="pln">
  </span><span class="com">// note: doing padding here saves us doing special-case packing for trailing 1 or 2 chars</span><span class="pln">
   
  </span><span class="kwd">for</span><span class="pln"> </span><span class="pun">(</span><span class="pln">c</span><span class="pun">=</span><span class="lit">0</span><span class="pun">;</span><span class="pln"> c</span><span class="pun">&lt;</span><span class="pln">plain</span><span class="pun">.</span><span class="pln">length</span><span class="pun">;</span><span class="pln"> c</span><span class="pun">+=</span><span class="lit">3</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">  </span><span class="com">// pack three octets into four hexets</span><span class="pln">
    o1 </span><span class="pun">=</span><span class="pln"> plain</span><span class="pun">.</span><span class="pln">charCodeAt</span><span class="pun">(</span><span class="pln">c</span><span class="pun">);</span><span class="pln">
    o2 </span><span class="pun">=</span><span class="pln"> plain</span><span class="pun">.</span><span class="pln">charCodeAt</span><span class="pun">(</span><span class="pln">c</span><span class="pun">+</span><span class="lit">1</span><span class="pun">);</span><span class="pln">
    o3 </span><span class="pun">=</span><span class="pln"> plain</span><span class="pun">.</span><span class="pln">charCodeAt</span><span class="pun">(</span><span class="pln">c</span><span class="pun">+</span><span class="lit">2</span><span class="pun">);</span><span class="pln">
      
    bits </span><span class="pun">=</span><span class="pln"> o1</span><span class="pun">&lt;&lt;</span><span class="lit">16</span><span class="pln"> </span><span class="pun">|</span><span class="pln"> o2</span><span class="pun">&lt;&lt;</span><span class="lit">8</span><span class="pln"> </span><span class="pun">|</span><span class="pln"> o3</span><span class="pun">;</span><span class="pln">
      
    h1 </span><span class="pun">=</span><span class="pln"> bits</span><span class="pun">&gt;&gt;</span><span class="lit">18</span><span class="pln"> </span><span class="pun">&amp;</span><span class="pln"> </span><span class="lit">0x3f</span><span class="pun">;</span><span class="pln">
    h2 </span><span class="pun">=</span><span class="pln"> bits</span><span class="pun">&gt;&gt;</span><span class="lit">12</span><span class="pln"> </span><span class="pun">&amp;</span><span class="pln"> </span><span class="lit">0x3f</span><span class="pun">;</span><span class="pln">
    h3 </span><span class="pun">=</span><span class="pln"> bits</span><span class="pun">&gt;&gt;</span><span class="lit">6</span><span class="pln"> </span><span class="pun">&amp;</span><span class="pln"> </span><span class="lit">0x3f</span><span class="pun">;</span><span class="pln">
    h4 </span><span class="pun">=</span><span class="pln"> bits </span><span class="pun">&amp;</span><span class="pln"> </span><span class="lit">0x3f</span><span class="pun">;</span><span class="pln">

    </span><span class="com">// use hextets to index into code string</span><span class="pln">
    e</span><span class="pun">[</span><span class="pln">c</span><span class="pun">/</span><span class="lit">3</span><span class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> b64</span><span class="pun">.</span><span class="pln">charAt</span><span class="pun">(</span><span class="pln">h1</span><span class="pun">)</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> b64</span><span class="pun">.</span><span class="pln">charAt</span><span class="pun">(</span><span class="pln">h2</span><span class="pun">)</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> b64</span><span class="pun">.</span><span class="pln">charAt</span><span class="pun">(</span><span class="pln">h3</span><span class="pun">)</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> b64</span><span class="pun">.</span><span class="pln">charAt</span><span class="pun">(</span><span class="pln">h4</span><span class="pun">);</span><span class="pln">
  </span><span class="pun">}</span><span class="pln">
  coded </span><span class="pun">=</span><span class="pln"> e</span><span class="pun">.</span><span class="pln">join</span><span class="pun">(</span><span class="str">''</span><span class="pun">);</span><span class="pln">  </span><span class="com">// join() is far faster than repeated string concatenation in IE</span><span class="pln">
  
  </span><span class="com">// replace 'A's from padded nulls with '='s</span><span class="pln">
  coded </span><span class="pun">=</span><span class="pln"> coded</span><span class="pun">.</span><span class="pln">slice</span><span class="pun">(</span><span class="lit">0</span><span class="pun">,</span><span class="pln"> coded</span><span class="pun">.</span><span class="pln">length</span><span class="pun">-</span><span class="pln">pad</span><span class="pun">.</span><span class="pln">length</span><span class="pun">)</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> pad</span><span class="pun">;</span><span class="pln">
   
  </span><span class="kwd">return</span><span class="pln"> coded</span><span class="pun">;</span><span class="pln">
</span><span class="pun">}</span><span class="pln">

</span><span class="com">/**
 * Decode string from Base64, as defined by RFC 4648 [http://tools.ietf.org/html/rfc4648]
 * (instance method extending String object). As per RFC 4648, newlines are not catered for.
 *
 * @param {String} str The string to be decoded from base-64
 * @param {Boolean} [utf8decode=false] Flag to indicate whether str is Unicode string to be decoded 
 *   from UTF8 after conversion from base64
 * @returns {String} decoded string
 */</span><span class="pln"> 
</span><span class="typ">Base64</span><span class="pun">.</span><span class="pln">decode </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">(</span><span class="pln">str</span><span class="pun">,</span><span class="pln"> utf8decode</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
  utf8decode </span><span class="pun">=</span><span class="pln">  </span><span class="pun">(</span><span class="kwd">typeof</span><span class="pln"> utf8decode </span><span class="pun">==</span><span class="pln"> </span><span class="str">'undefined'</span><span class="pun">)</span><span class="pln"> </span><span class="pun">?</span><span class="pln"> </span><span class="kwd">false</span><span class="pln"> </span><span class="pun">:</span><span class="pln"> utf8decode</span><span class="pun">;</span><span class="pln">
  </span><span class="kwd">var</span><span class="pln"> o1</span><span class="pun">,</span><span class="pln"> o2</span><span class="pun">,</span><span class="pln"> o3</span><span class="pun">,</span><span class="pln"> h1</span><span class="pun">,</span><span class="pln"> h2</span><span class="pun">,</span><span class="pln"> h3</span><span class="pun">,</span><span class="pln"> h4</span><span class="pun">,</span><span class="pln"> bits</span><span class="pun">,</span><span class="pln"> d</span><span class="pun">=[],</span><span class="pln"> plain</span><span class="pun">,</span><span class="pln"> coded</span><span class="pun">;</span><span class="pln">
  </span><span class="kwd">var</span><span class="pln"> b64 </span><span class="pun">=</span><span class="pln"> </span><span class="typ">Base64</span><span class="pun">.</span><span class="pln">code</span><span class="pun">;</span><span class="pln">

  coded </span><span class="pun">=</span><span class="pln"> utf8decode </span><span class="pun">?</span><span class="pln"> str</span><span class="pun">.</span><span class="pln">decodeUTF8</span><span class="pun">()</span><span class="pln"> </span><span class="pun">:</span><span class="pln"> str</span><span class="pun">;</span><span class="pln">
  
  
  </span><span class="kwd">for</span><span class="pln"> </span><span class="pun">(</span><span class="kwd">var</span><span class="pln"> c</span><span class="pun">=</span><span class="lit">0</span><span class="pun">;</span><span class="pln"> c</span><span class="pun">&lt;</span><span class="pln">coded</span><span class="pun">.</span><span class="pln">length</span><span class="pun">;</span><span class="pln"> c</span><span class="pun">+=</span><span class="lit">4</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">  </span><span class="com">// unpack four hexets into three octets</span><span class="pln">
    h1 </span><span class="pun">=</span><span class="pln"> b64</span><span class="pun">.</span><span class="pln">indexOf</span><span class="pun">(</span><span class="pln">coded</span><span class="pun">.</span><span class="pln">charAt</span><span class="pun">(</span><span class="pln">c</span><span class="pun">));</span><span class="pln">
    h2 </span><span class="pun">=</span><span class="pln"> b64</span><span class="pun">.</span><span class="pln">indexOf</span><span class="pun">(</span><span class="pln">coded</span><span class="pun">.</span><span class="pln">charAt</span><span class="pun">(</span><span class="pln">c</span><span class="pun">+</span><span class="lit">1</span><span class="pun">));</span><span class="pln">
    h3 </span><span class="pun">=</span><span class="pln"> b64</span><span class="pun">.</span><span class="pln">indexOf</span><span class="pun">(</span><span class="pln">coded</span><span class="pun">.</span><span class="pln">charAt</span><span class="pun">(</span><span class="pln">c</span><span class="pun">+</span><span class="lit">2</span><span class="pun">));</span><span class="pln">
    h4 </span><span class="pun">=</span><span class="pln"> b64</span><span class="pun">.</span><span class="pln">indexOf</span><span class="pun">(</span><span class="pln">coded</span><span class="pun">.</span><span class="pln">charAt</span><span class="pun">(</span><span class="pln">c</span><span class="pun">+</span><span class="lit">3</span><span class="pun">));</span><span class="pln">
      
    bits </span><span class="pun">=</span><span class="pln"> h1</span><span class="pun">&lt;&lt;</span><span class="lit">18</span><span class="pln"> </span><span class="pun">|</span><span class="pln"> h2</span><span class="pun">&lt;&lt;</span><span class="lit">12</span><span class="pln"> </span><span class="pun">|</span><span class="pln"> h3</span><span class="pun">&lt;&lt;</span><span class="lit">6</span><span class="pln"> </span><span class="pun">|</span><span class="pln"> h4</span><span class="pun">;</span><span class="pln">
      
    o1 </span><span class="pun">=</span><span class="pln"> bits</span><span class="pun">&gt;&gt;&gt;</span><span class="lit">16</span><span class="pln"> </span><span class="pun">&amp;</span><span class="pln"> </span><span class="lit">0xff</span><span class="pun">;</span><span class="pln">
    o2 </span><span class="pun">=</span><span class="pln"> bits</span><span class="pun">&gt;&gt;&gt;</span><span class="lit">8</span><span class="pln"> </span><span class="pun">&amp;</span><span class="pln"> </span><span class="lit">0xff</span><span class="pun">;</span><span class="pln">
    o3 </span><span class="pun">=</span><span class="pln"> bits </span><span class="pun">&amp;</span><span class="pln"> </span><span class="lit">0xff</span><span class="pun">;</span><span class="pln">
    
    d</span><span class="pun">[</span><span class="pln">c</span><span class="pun">/</span><span class="lit">4</span><span class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="typ">String</span><span class="pun">.</span><span class="pln">fromCharCode</span><span class="pun">(</span><span class="pln">o1</span><span class="pun">,</span><span class="pln"> o2</span><span class="pun">,</span><span class="pln"> o3</span><span class="pun">);</span><span class="pln">
    </span><span class="com">// check for padding</span><span class="pln">
    </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">h4 </span><span class="pun">==</span><span class="pln"> </span><span class="lit">0x40</span><span class="pun">)</span><span class="pln"> d</span><span class="pun">[</span><span class="pln">c</span><span class="pun">/</span><span class="lit">4</span><span class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="typ">String</span><span class="pun">.</span><span class="pln">fromCharCode</span><span class="pun">(</span><span class="pln">o1</span><span class="pun">,</span><span class="pln"> o2</span><span class="pun">);</span><span class="pln">
    </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">h3 </span><span class="pun">==</span><span class="pln"> </span><span class="lit">0x40</span><span class="pun">)</span><span class="pln"> d</span><span class="pun">[</span><span class="pln">c</span><span class="pun">/</span><span class="lit">4</span><span class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="typ">String</span><span class="pun">.</span><span class="pln">fromCharCode</span><span class="pun">(</span><span class="pln">o1</span><span class="pun">);</span><span class="pln">
  </span><span class="pun">}</span><span class="pln">
  plain </span><span class="pun">=</span><span class="pln"> d</span><span class="pun">.</span><span class="pln">join</span><span class="pun">(</span><span class="str">''</span><span class="pun">);</span><span class="pln">  </span><span class="com">// join() is far faster than repeated string concatenation in IE</span><span class="pln">
   
  </span><span class="kwd">return</span><span class="pln"> utf8decode </span><span class="pun">?</span><span class="pln"> plain</span><span class="pun">.</span><span class="pln">decodeUTF8</span><span class="pun">()</span><span class="pln"> </span><span class="pun">:</span><span class="pln"> plain</span><span class="pun">;</span><span class="pln"> 
</span><span class="pun">}</span><span class="pln">


</span><span class="com">/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -  */</span><span class="pln">
</span><span class="com">/*  Utf8 class: encode / decode between multi-byte Unicode characters and UTF-8 multiple          */</span><span class="pln">
</span><span class="com">/*              single-byte character encoding (c) Chris Veness 2002-2012                         */</span><span class="pln">
</span><span class="com">/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -  */</span><span class="pln">

</span><span class="kwd">var</span><span class="pln"> </span><span class="typ">Utf8</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="pun">{};</span><span class="pln">  </span><span class="com">// Utf8 namespace</span><span class="pln">

</span><span class="com">/**
 * Encode multi-byte Unicode string into utf-8 multiple single-byte characters 
 * (BMP / basic multilingual plane only)
 *
 * Chars in range U+0080 - U+07FF are encoded in 2 chars, U+0800 - U+FFFF in 3 chars
 *
 * @param {String} strUni Unicode string to be encoded as UTF-8
 * @returns {String} encoded string
 */</span><span class="pln">
</span><span class="typ">Utf8</span><span class="pun">.</span><span class="pln">encode </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">(</span><span class="pln">strUni</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
  </span><span class="com">// use regular expressions &amp; String.replace callback function for better efficiency </span><span class="pln">
  </span><span class="com">// than procedural approaches</span><span class="pln">
  </span><span class="kwd">var</span><span class="pln"> strUtf </span><span class="pun">=</span><span class="pln"> strUni</span><span class="pun">.</span><span class="pln">replace</span><span class="pun">(</span><span class="pln">
      </span><span class="str">/[\u0080-\u07ff]/</span><span class="pln">g</span><span class="pun">,</span><span class="pln">  </span><span class="com">// U+0080 - U+07FF =&gt; 2 bytes 110yyyyy, 10zzzzzz</span><span class="pln">
      </span><span class="kwd">function</span><span class="pun">(</span><span class="pln">c</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> 
        </span><span class="kwd">var</span><span class="pln"> cc </span><span class="pun">=</span><span class="pln"> c</span><span class="pun">.</span><span class="pln">charCodeAt</span><span class="pun">(</span><span class="lit">0</span><span class="pun">);</span><span class="pln">
        </span><span class="kwd">return</span><span class="pln"> </span><span class="typ">String</span><span class="pun">.</span><span class="pln">fromCharCode</span><span class="pun">(</span><span class="lit">0xc0</span><span class="pln"> </span><span class="pun">|</span><span class="pln"> cc</span><span class="pun">&gt;&gt;</span><span class="lit">6</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0x80</span><span class="pln"> </span><span class="pun">|</span><span class="pln"> cc</span><span class="pun">&amp;</span><span class="lit">0x3f</span><span class="pun">);</span><span class="pln"> </span><span class="pun">}</span><span class="pln">
    </span><span class="pun">);</span><span class="pln">
  strUtf </span><span class="pun">=</span><span class="pln"> strUtf</span><span class="pun">.</span><span class="pln">replace</span><span class="pun">(</span><span class="pln">
      </span><span class="str">/[\u0800-\uffff]/</span><span class="pln">g</span><span class="pun">,</span><span class="pln">  </span><span class="com">// U+0800 - U+FFFF =&gt; 3 bytes 1110xxxx, 10yyyyyy, 10zzzzzz</span><span class="pln">
      </span><span class="kwd">function</span><span class="pun">(</span><span class="pln">c</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> 
        </span><span class="kwd">var</span><span class="pln"> cc </span><span class="pun">=</span><span class="pln"> c</span><span class="pun">.</span><span class="pln">charCodeAt</span><span class="pun">(</span><span class="lit">0</span><span class="pun">);</span><span class="pln"> 
        </span><span class="kwd">return</span><span class="pln"> </span><span class="typ">String</span><span class="pun">.</span><span class="pln">fromCharCode</span><span class="pun">(</span><span class="lit">0xe0</span><span class="pln"> </span><span class="pun">|</span><span class="pln"> cc</span><span class="pun">&gt;&gt;</span><span class="lit">12</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0x80</span><span class="pln"> </span><span class="pun">|</span><span class="pln"> cc</span><span class="pun">&gt;&gt;</span><span class="lit">6</span><span class="pun">&amp;</span><span class="lit">0x3F</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0x80</span><span class="pln"> </span><span class="pun">|</span><span class="pln"> cc</span><span class="pun">&amp;</span><span class="lit">0x3f</span><span class="pun">);</span><span class="pln"> </span><span class="pun">}</span><span class="pln">
    </span><span class="pun">);</span><span class="pln">
  </span><span class="kwd">return</span><span class="pln"> strUtf</span><span class="pun">;</span><span class="pln">
</span><span class="pun">}</span><span class="pln">

</span><span class="com">/**
 * Decode utf-8 encoded string back into multi-byte Unicode characters
 *
 * @param {String} strUtf UTF-8 string to be decoded back to Unicode
 * @returns {String} decoded string
 */</span><span class="pln">
</span><span class="typ">Utf8</span><span class="pun">.</span><span class="pln">decode </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">(</span><span class="pln">strUtf</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
  </span><span class="com">// note: decode 3-byte chars first as decoded 2-byte strings could appear to be 3-byte char!</span><span class="pln">
  </span><span class="kwd">var</span><span class="pln"> strUni </span><span class="pun">=</span><span class="pln"> strUtf</span><span class="pun">.</span><span class="pln">replace</span><span class="pun">(</span><span class="pln">
      </span><span class="str">/[\u00e0-\u00ef][\u0080-\u00bf][\u0080-\u00bf]/</span><span class="pln">g</span><span class="pun">,</span><span class="pln">  </span><span class="com">// 3-byte chars</span><span class="pln">
      </span><span class="kwd">function</span><span class="pun">(</span><span class="pln">c</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">  </span><span class="com">// (note parentheses for precence)</span><span class="pln">
        </span><span class="kwd">var</span><span class="pln"> cc </span><span class="pun">=</span><span class="pln"> </span><span class="pun">((</span><span class="pln">c</span><span class="pun">.</span><span class="pln">charCodeAt</span><span class="pun">(</span><span class="lit">0</span><span class="pun">)&amp;</span><span class="lit">0x0f</span><span class="pun">)&lt;&lt;</span><span class="lit">12</span><span class="pun">)</span><span class="pln"> </span><span class="pun">|</span><span class="pln"> </span><span class="pun">((</span><span class="pln">c</span><span class="pun">.</span><span class="pln">charCodeAt</span><span class="pun">(</span><span class="lit">1</span><span class="pun">)&amp;</span><span class="lit">0x3f</span><span class="pun">)&lt;&lt;</span><span class="lit">6</span><span class="pun">)</span><span class="pln"> </span><span class="pun">|</span><span class="pln"> </span><span class="pun">(</span><span class="pln"> c</span><span class="pun">.</span><span class="pln">charCodeAt</span><span class="pun">(</span><span class="lit">2</span><span class="pun">)&amp;</span><span class="lit">0x3f</span><span class="pun">);</span><span class="pln"> 
        </span><span class="kwd">return</span><span class="pln"> </span><span class="typ">String</span><span class="pun">.</span><span class="pln">fromCharCode</span><span class="pun">(</span><span class="pln">cc</span><span class="pun">);</span><span class="pln"> </span><span class="pun">}</span><span class="pln">
    </span><span class="pun">);</span><span class="pln">
  strUni </span><span class="pun">=</span><span class="pln"> strUni</span><span class="pun">.</span><span class="pln">replace</span><span class="pun">(</span><span class="pln">
      </span><span class="str">/[\u00c0-\u00df][\u0080-\u00bf]/</span><span class="pln">g</span><span class="pun">,</span><span class="pln">                 </span><span class="com">// 2-byte chars</span><span class="pln">
      </span><span class="kwd">function</span><span class="pun">(</span><span class="pln">c</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">  </span><span class="com">// (note parentheses for precence)</span><span class="pln">
        </span><span class="kwd">var</span><span class="pln"> cc </span><span class="pun">=</span><span class="pln"> </span><span class="pun">(</span><span class="pln">c</span><span class="pun">.</span><span class="pln">charCodeAt</span><span class="pun">(</span><span class="lit">0</span><span class="pun">)&amp;</span><span class="lit">0x1f</span><span class="pun">)&lt;&lt;</span><span class="lit">6</span><span class="pln"> </span><span class="pun">|</span><span class="pln"> c</span><span class="pun">.</span><span class="pln">charCodeAt</span><span class="pun">(</span><span class="lit">1</span><span class="pun">)&amp;</span><span class="lit">0x3f</span><span class="pun">;</span><span class="pln">
        </span><span class="kwd">return</span><span class="pln"> </span><span class="typ">String</span><span class="pun">.</span><span class="pln">fromCharCode</span><span class="pun">(</span><span class="pln">cc</span><span class="pun">);</span><span class="pln"> </span><span class="pun">}</span><span class="pln">
    </span><span class="pun">);</span><span class="pln">
  </span><span class="kwd">return</span><span class="pln"> strUni</span><span class="pun">;</span><span class="pln">
</span><span class="pun">}</span><span class="pln">

</span><span class="com">/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -  */</span></pre>



</body></html>