<?php

/*
http://h.univision.com/media/14/01/08/140108_656/140108_2890243_Que_Pobres_Tan_Ricos_Capitulo_3_1389212211_1200.mp4
http://h.univision.com/media/1203/16/07/21/3215416/160721_3215416_Tres_Veces_Ana_Capitulo_41_1469575170_1800.m3u8
http://h.univision.com/media/1203/16/07/21/3215416/160721_3215416_Tres_Veces_Ana_Capitulo_41_1469575170_1200.mp4
http://h.univision.com/media/1203/16/07/21/3215416/160721_3215416_Tres_Veces_Ana_Capitulo_41_1469575170_2500.m3u8
*/

/*
http://www.univision.com/shows/el-gordo-y-la-flaca/capitulo-1-321clarissa-las-duras-criticas-llevaron-a-clarissa-molina-a-derrumbarse-en-llanto-video

<div id="ifc41480966414fbc8c8848ff55ba52f7" class="uvn-video_player"
    data-uvn-player
    data-video="extId:3302448"

    data-anchor-enabled="true"
    data-rendition-url="http://playvideo.univision.com/media/variant1/3302448_1490744755.m3u8"
    data-fallback-rendition-url="http://playvideo.univision.com/media/7/17/03/24/3302448/170324_3302448_Capitulo_1___321Clarissa__las_duras_criticas_1490635969_800.mp4"
    data-autoplay="true"
    data-auth-required="false"
    data-resource="univision"
    data-mrss="&lt;rss version=&quot;2.0&quot; xmlns:media=&quot;http://search.yahoo.com/mrss/&quot;&gt;&lt;channel&gt;&lt;title&gt;univision&lt;/title&gt;&lt;item&gt;&lt;title&gt;El+Gordo+y+La+Flaca&lt;/title&gt;&lt;guid&gt;3302448&lt;/guid&gt;&lt;media:rating scheme=&quot;urn:v-chip&quot;&gt;&lt;/media:rating&gt;&lt;/item&gt;&lt;/channel&gt;&lt;/rss&gt;"

    data-title="Capítulo 1: #321Clarissa, las duras críticas llevaron a Clarissa Molina a derrumbarse en llanto"
    data-short-title="Capítulo 1: #321Clarissa, las duras críticas llevaron a Clarissa Molina a derrumbarse en llanto"
    data-description="Tras dolorosos comentarios recibidos durante su primera semana como presentadora de El Gordo y la Flaca, Clarissa decidió tomar cartas en el asunto para mejorar la manera en que se expresa frente a las cámaras."
    data-cover-image="http://cdn1.uvnimg.com/dims4/default/ff997e9/2147483647/thumbnail/1024x576/quality/75/?url=http%3A%2F%2Fcdn2.uvnimg.com%2F7a%2Fd7%2F3f1cdd854de9b65944ac22e2e2c9%2Fe714863f8cb247f4b7194666c2116743"
    data-duration="307"
    data-language="es"
    data-video-type="clip"
    data-rating="Not Rated"
    data-primary-tag="El Gordo y La Flaca"
    data-channel="tv_shows_elgordoylaflaca_video"
    data-genre=""

    data-mcpproviderid="3302448"
    data-fw-settings="{&quot;fwSectionId&quot;:&quot;d.tv_shows_elgordoylaflaca_video&quot;,&quot;userAgent&quot;:&quot;Mozilla/5.0 (Windows NT 6.1; WOW64; rv:53.0) Gecko/20100101 Firefox/53.0&quot;,&quot;customParams&quot;:&quot;&quot;,&quot;slotParams&quot;:&quot;ptgt=s&amp;slid=Comp&amp;w=300&amp;h=250&amp;flag=+cmpn;ptgt=a&amp;slid=Preroll&amp;tpcl=PREROLL&amp;flag=+cmpn&quot;,&quot;prodEnvironmentSettings&quot;:{&quot;freewheelNetworkCode&quot;:&quot;112214&quot;,&quot;freewheelHost&quot;:&quot;1b656.v.fwmrm.net&quot;,&quot;freewheelProfilePath&quot;:&quot;univision_Live_HTML5&quot;},&quot;devEnvironmentSettings&quot;:{&quot;freewheelNetworkCode&quot;:&quot;111976&quot;,&quot;freewheelHost&quot;:&quot;1b656.v.fwmrm.net&quot;,&quot;freewheelProfilePath&quot;:&quot;univision_test_HTML5&quot;}}"
    data-enable-jw-ad-manager="true"
    data-ad-slot="ptgt=s&amp;slid=Comp&amp;w=300&amp;h=250&amp;flag=+cmpn;ptgt=a&amp;slid=Preroll&amp;tpcl=PREROLL&amp;flag=+cmpn"

    data-playlist=""

    data-unauth-tvss-url="https://usaplusauth.univision.com/api/v1/video-auth/url-signature-token"
    data-auth-tvss-url="https://usaplusauth.univision.com/api/v1/video-auth/verify-entitlement"
    data-unauth-tvss2-url="https://usaplusauth.univision.com/api/v2/video-auth/url-signature-tokens"
    data-tvss-clips-version="V1"

    data-application-id=""
    data-disable-concurrency-monitoring="false"
    data-primetime-domain-url=""

    data-dfxp-captions="{&quot;en&quot;:null,&quot;es&quot;:null}"

    data-eov="true"
    data-eov-url="/feed/related-videos?client_id=18bc31b21929a2e8369c2acfd1bcfa604e8c278d&amp;signature=4bab36d84b9fbd06d1ae508d71b5235aa2609552"
    data-eov-videoid="0000015b-10d7-d870-a97b-58f7dcfc0000"
    data-eov-siteid="00000147-f3a5-d4ea-a95f-fbb7f52b0000"
    data-eov-count="0"
    data-upnext-cookielimit='10'
    data-upnext-cookieexp='1'

    data-tms-id=""
    data-advertiser=""
    data-custom-video-type=""
    data-friendly-key="Capítulo 1: #321Clarissa, las duras críticas llevaron a Clarissa Molina a derrumbarse en llanto"
    data-program-name="El Gordo y La Flaca"
    data-tv-show-season=""
    data-tv-show="El Gordo y La Flaca"
    data-content-type="Entertainment"

    data-mcpnetworkid="univision"
    data-external-id=""

    data-ad-slot-cue-points="[]"

    data-comscore-air-date="1490396160000"
    data-air-date-day-format="2017-03-24"

    data-source="Univision"
    data-nielsen-vcid="c02"

    data-enable-infinigraph="true"
>
</div>


No van (faltan tokens y hmac)
http://playvideo.univision.com/media/variant1/3302448_1490744755.m3u8
http://playvideo.univision.com/media/7/17/03/24/3302448/170324_3302448_Capitulo_1___321Clarissa__las_duras_criticas_1490635969_800.mp4

https://usaplusauth.univision.com/api/v1/video-auth/url-signature-token?url=http://playvideo.univision.com/media/variant1/3302448_1490744755.m3u8
{"signature":"http://playvideo.univision.com/media/variant1/3302448_1490744755.m3u8?UNIVOD=exp=1490798353~hmac=f53c406530265838ac241c1c1bc989da8beef666f6236fa598825d17c72f6148"}
http://playvideo.univision.com/media/variant1/3302448_1490744755.m3u8?UNIVOD=exp=1490798353~hmac=f53c406530265838ac241c1c1bc989da8beef666f6236fa598825d17c72f6148

https://usaplusauth.univision.com/api/v1/video-auth/url-signature-token?url=http://playvideo.univision.com/media/7/17/03/24/3302448/170324_3302448_Capitulo_1___321Clarissa__las_duras_criticas_1490635969_800.mp4
{"signature":"http://playvideo.univision.com/media/7/17/03/24/3302448/170324_3302448_Capitulo_1___321Clarissa__las_duras_criticas_1490635969_800.mp4?UNIVOD=exp=1490798353~hmac=931aa6ebf4594adda3dcf7448f7064cd0ec06cb43dd276176e64ed5cbc3ed17b"}
http://playvideo.univision.com/media/7/17/03/24/3302448/170324_3302448_Capitulo_1___321Clarissa__las_duras_criticas_1490635969_800.mp4?UNIVOD=exp=1490798353~hmac=931aa6ebf4594adda3dcf7448f7064cd0ec06cb43dd276176e64ed5cbc3ed17b
http://h.univision.com/media/7/17/03/24/3302448/170324_3302448_Capitulo_1___321Clarissa__las_duras_criticas_1490635969_800.mp4

#EXTM3U
#EXT-X-MEDIA:TYPE=CLOSED-CAPTIONS,GROUP-ID="cc",LANGUAGE="es",NAME="Spanish",AUTOSELECT=YES,INSTREAM-ID="CC1"
#EXT-X-STREAM-INF:PROGRAM-ID=1, BANDWIDTH=414000
http://h.univision.com/media/7/17/03/24/3302448/170324_3302448_Capitulo_1___321Clarissa__las_duras_criticas_1490635969_350.m3u8
#EXT-X-STREAM-INF:PROGRAM-ID=1, BANDWIDTH=846000
http://h.univision.com/media/7/17/03/24/3302448/170324_3302448_Capitulo_1___321Clarissa__las_duras_criticas_1490635969_750.m3u8
#EXT-X-STREAM-INF:PROGRAM-ID=1, BANDWIDTH=1596000
http://h.univision.com/media/7/17/03/24/3302448/170324_3302448_Capitulo_1___321Clarissa__las_duras_criticas_1490635969_1500.m3u8
#EXT-X-STREAM-INF:PROGRAM-ID=1, BANDWIDTH=2378000
http://h.univision.com/media/7/17/03/24/3302448/170324_3302448_Capitulo_1___321Clarissa__las_duras_criticas_1490635969_2250.m3u8
#EXT-X-STREAM-INF:PROGRAM-ID=1, BANDWIDTH=3528000
http://h.univision.com/media/7/17/03/24/3302448/170324_3302448_Capitulo_1___321Clarissa__las_duras_criticas_1490635969_3400.m3u8
#EXT-X-STREAM-INF:PROGRAM-ID=1, BANDWIDTH=4628000
http://h.univision.com/media/7/17/03/24/3302448/170324_3302448_Capitulo_1___321Clarissa__las_duras_criticas_1490635969_4500.m3u8
#EXT-X-STREAM-INF:PROGRAM-ID=1, BANDWIDTH=6128000
http://h.univision.com/media/7/17/03/24/3302448/170324_3302448_Capitulo_1___321Clarissa__las_duras_criticas_1490635969_6000.m3u8

Parece que esto es lo que pone el token:
http://dst.infinigraph.com/kraken/js/kraken-view-univision.js?1490794362008



https://usaplusauth.univision.com/api/v1/video-auth/url-signature-token?url=https://playvideo-univision.akamaized.net/media/650/17/06/12/3331814/170612_3331814_En_un_minuto__Padres_y_madres_solteros_tendr_1497306770_800.mp4


*/

class Univision extends cadena{

function calculaMovil() {
	$w = $this->web . 'FINAL';
	$id = entre1y2($w, '?id=', 'FINAL');
	dbug('id=' . $id);
	$this->univisionID($id);
}

function calcula() {
	if (enString($this->web_descargada, 'video_id=')) {
		$id = entre1y2($this->web_descargada, 'video_id=', ',');
	} elseif (enString($this->web_descargada, 'fw_video_asset_id')) {
		preg_match("@fw_video_asset_id.*?([0-9]+)@", $this->web_descargada, $match);
		$id = $match[1];
	} elseif (enString($this->web_descargada, 'videoEmbedCode')) {
		preg_match("@videoEmbedCode.*?([0-9]+)@", $this->web_descargada, $match);
		$id = $match[1];
	} elseif (enString($this->web_descargada, 'data-video="extId:')) {
		$id = entre1y2($this->web_descargada, 'data-video="extId:', '"');
	} else {
		return;
	}

	dbug('id=' . $id);
	$this->univisionID($id);
}

function calculaUVideos() {
	if (enString($this->web_descargada, 'data-video="extId:')) {
		$id = entre1y2($this->web_descargada, 'data-video="extId:', '"');
	} else if (enString($this->web_descargada, '<meta property="og:image" content="')) {
		$imagen_preid = entre1y2($this->web_descargada, '<meta property="og:image" content="', '"');
		$id = substr($imagen_preid, strrposF($imagen_preid, '/'));
	} else {
		return;
	}

	dbug('id=' . $id);
	$this->univisionID($id);
}

function univisionID($id) {
	dbug('univisionID');

	$obtenido = array('enlaces' => array());

	//imagen
	$imagen = entre1y2($this->web_descargada, 'name="twitter:image" content="', '"');
	dbug('imagen=' . $imagen);

	//titulo
	$titulo = entre1y2($this->web_descargada, 'name="twitter:title" content="', '"');
	$titulo = limpiaTitulo($titulo);
	dbug('titulo=' . $titulo);

	$urls = array();
	
	//urls en formato: /120615_2708697_El_Talisman_Capitulo_98_99___Ultimo_capitulo_1339800465_2000.mp4

	// http://vmscdn-download.s3.amazonaws.com/videos_mcm/variant/2912557.m3u8
	// http://playvideo.univision.com/media/variant1/3302448_1490744755.m3u8
	// https://usaplusauth.univision.com/api/v1/video-auth/url-signature-token?url=http://playvideo.univision.com/media/variant1/3302448_1490744755.m3u8
	// {"signature":"http://playvideo.univision.com/media/variant1/3302448_1490744755.m3u8?UNIVOD=exp=1490798353~hmac=f53c406530265838ac241c1c1bc989da8beef666f6236fa598825d17c72f6148"}
	// {id}_{timestamp}.m3u8/mp4
	
	// http://h.univision.com/media/650/17/06/12/3331814/170612_3331814_En_un_minuto__Padres_y_madres_solteros_tendr_1497306770_800.mp4
	// https://playvideo-univision.akamaized.net/media/650/17/06/12/3331814/170612_3331814_En_un_minuto__Padres_y_madres_solteros_tendr_1497306770_800.mp4
	
	// data-rendition-url="https://playvideo-univision.akamaized.net/media/variant1/3331814_1497307069.m3u8"
	// data-fallback-rendition-url="https://playvideo-univision.akamaized.net/media/650/17/06/12/3331814/170612_3331814_En_un_minuto__Padres_y_madres_solteros_tendr_1497306770_800.mp4"

	
	//$m3u8FuenteUrls = 'http://vmscdn-download.s3.amazonaws.com/videos_mcm/variant/' . $id . '.m3u8';
	if (preg_match('@https?://(?:playvideo\.univision\.com|playvideo-univision\.akamaized\.net)(/media/variant[0-9]+/(.+?)\.m3u8)@', $this->web_descargada, $matches)) {
		dbug_r($matches);
		$m3u8FuenteUrls = 'http://playvideo.univision.com' . $matches[1];
	} else {
		$bruteforceTimestamp = entre1y2($this->web_descargada, '<meta itemprop="uploadDate" content="', '"');
		dbug_($bruteforceTimestamp);
		$bruteforceTimestamp = strtotime($bruteforceTimestamp);
		dbug_($bruteforceTimestamp);
		// $bruteforceTimestamp es similar a uploadDate, pero no es exactamente la misma, por lo que habría que recorrer todas las timestamp cercanas para encontrar el número
		$m3u8FuenteUrls = 'http://playvideo.univision.com/media/variant1/'.$id.'_'.$bruteforceTimestamp.'.m3u8';
	}
	dbug('$m3u8FuenteUrls = ' . $m3u8FuenteUrls);
	$m3u8FuenteUrls = 'https://usaplusauth.univision.com/api/v1/video-auth/url-signature-token?url=' . $m3u8FuenteUrls;

	$m3u8FuenteUrls = CargaWebCurl($m3u8FuenteUrls);
	dbug_($m3u8FuenteUrls);
	
	$m3u8FuenteUrls = json_decode($m3u8FuenteUrls, true);
	dbug_r($m3u8FuenteUrls);
	$m3u8FuenteUrls = $m3u8FuenteUrls['signature'];
	dbug_($m3u8FuenteUrls);
	
	$m3u8FuenteUrls = CargaWebCurl($m3u8FuenteUrls);
	
	$calidadesM3U8 = array(6000, 4500, 3400, 2250, 1500, 750, 350);
	$urls = array();

	// http://h.univision.com/media/7/17/03/24/3302448/170324_3302448_Capitulo_1___321Clarissa__las_duras_criticas_1490635969_6000.m3u8
	$modo1 = preg_match_all('@(https?://.*media.*?)_([0-9]{3,4})\.m3u8@', $m3u8FuenteUrls, $matches);
	$modo2 = !$modo1 && preg_match_all('@(https?://.*media.*?)_([0-9]{3,4})\.mp4@', $this->web_descargada, $matches);
	if ($modo1 || $modo2) {
		dbug_r($matches);
		
		for ($i = 0, $i_t = count($matches[0]); $i < $i_t; $i++) {
			if (!in_array($matches[2][$i], $calidadesM3U8)) {
				$url = $matches[0][$i];
				if ($modo2)
					$url = preg_replace('@http.+/media/@', 'http://h.univision.com/media/', $url);
				$urls[] = array($url, $matches[2][$i]);
			}
		}
		foreach ($calidadesM3U8 as $calidad) {
			$url = $matches[1][0].'_'.$calidad.'.m3u8';
			if ($modo2)
				$url = preg_replace('@http.+/media/@', 'http://h.univision.com/media/', $url);
			$urls[] = array($url, $calidad);
		}
		$urls[] = array($matches[1][0] . '_800.mp4', 800);
		//$calidades = array(2000, 1200, 810, 800, 510, 500, 270, 150);
	} else {
		dbug("No se encuentra por m3u8. fail calidades altas.");
	}

	$urls = sortmulti($urls, 1, 'asc');
	$urls = array_reverse($urls);

	$urls_length = count($urls);
	for ($i = 0; $i < $urls_length; $i++) {
		if($urls[$i][1] == 2000){
			$preContext =
			array('http'=>
				array(
					'method' => 'HEAD',
					'header' => "User-agent: Mozilla/5.0 (Windows NT 6.1; rv:11.0) Gecko/20100101 Firefox/11.0\r\n".
								"Connection: close\r\n".
								"Accept-Language: es-ES,es;en-US;en\r\n".
								"Accept: text/html,application/xhtml+xml,application/xml\r\n",
					'timeout' => 5,
					'ignore_errors' => '1'
				)
			);
			
			$preContext = stream_context_create($preContext);
			if(file_get_contents($urls[$i][0], false, $preContext) === false){
				dbug('no se puede abrir la url de calidad 2000');
				continue;
			}
			dbug_r($http_response_header);
			if(strpos($http_response_header[0], ' 404 ')){
				dbug('la url de calidad 2000 da 404');
				continue;
			}
		}
		$obtenido['enlaces'][] = array(
			'titulo' => 'Calidad: ' . $urls[$i][1] . ' Kbps',
			'url' => $urls[$i][0],
			'url_txt' => 'Descargar',
			'tipo' => enString($urls[$i][0], '.m3u8') ? 'm3u8' : 'http'
		);
	}

	if (isset($json)) {
		for ($i = 0, $ii = count($json['captions']); $i < $ii; $i++) {
			if ($json['captions'][$i]['language'] === 'es') {
				$url = $json['captions'][$i]['url'];
				$obtenido['enlaces'][] = array(
					'url_txt' => 'Subtítulos en formato ' . substr($url, strrposF($url, '.')),
					'url' => $url,
					'tipo' => 'srt'
				);
			}
		}
	}

	$obtenido['titulo'] = $titulo;
	$obtenido['imagen'] = $imagen;
	
	$obtenido['alerta_especifica'] = 'Es necesario usar un proxy si el vídeo no está disponible para su país.<br/>Es <b>necesario</b> usar JDownloader (<a href="http://jdownloader.org/download/index">Descargar</a>) para poder descargar los enlaces con calidad distinta a 800Kbps.<br/>Una vez instalado, ábrelo y reintenta la descarga en Descargavídeos.<br/>Si no funciona alguna calidad prueba una menor.';

	finalCadena($obtenido, false);
}

}
